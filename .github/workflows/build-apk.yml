name: Build FamilyHub APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:

  security-check:
    name: Sécurité & Qualité du code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Vérification sécurité HTML/JS
        run: |
          echo "=== Secrets codés en dur ==="
          if grep -rn "password\s*=\|api_key\s*=" --include="*.js" --include="*.html" .; then
            echo "⚠️ Potentiels secrets trouvés - vérifier manuellement"
          else
            echo "✅ Aucun secret détecté"
          fi

      - name: Vérification taille des fichiers
        run: |
          echo "=== Taille des fichiers HTML ==="
          for f in $(find . -name "*.html" -not -path "*/node_modules/*"); do
            size=$(wc -c < "$f")
            kb=$((size / 1024))
            if [ $kb -gt 200 ]; then
              echo "⚠️ $f — ${kb}KB (volumineux)"
            else
              echo "✅ $f — ${kb}KB"
            fi
          done

  build:
    name: Build APK Android
    runs-on: ubuntu-latest
    needs: security-check
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Installer outils Android
        run: |
          sdkmanager "build-tools;34.0.0" "platforms;android-34" "platform-tools"
          echo "✅ Android SDK configuré"

      - name: Installer dépendances npm
        run: |
          npm install
          echo "✅ npm install terminé"

      - name: Préparer www/ (webDir Capacitor)
        run: |
          mkdir -p www
          cp index.html www/
          cp manifest.json www/
          cp sw.js www/
          cp -r icons www/
          cp -r locker-tracker www/
          cp -r liste-courses www/
          cp -r todo-partage www/
          cp -r cave-spiritueux www/
          cp -r menus-semaine www/
          echo "✅ Contenu de www/ :"
          ls www/

      - name: Capacitor - Ajouter Android
        run: |
          npx cap add android
          echo "✅ Projet Android généré"

      - name: Capacitor - Sync
        run: |
          npx cap sync android
          echo "✅ Sync terminé"

      - name: Rendre gradlew exécutable
        run: chmod +x android/gradlew

      - name: Copier les plugins Java natifs
        run: |
          DEST="android/app/src/main/java/com/famille/dieulgandet"
          mkdir -p "$DEST"
          cp src-android/MainActivity.java "$DEST/"
          cp src-android/SmsReaderPlugin.java "$DEST/"
          echo "✅ Plugins Java copiés :"
          grep "^package" "$DEST/"*.java

      - name: Patcher AndroidManifest (permissions SMS)
        run: |
          M="android/app/src/main/AndroidManifest.xml"
          echo "--- Manifest avant patch ---"
          grep "permission" "$M" || echo "(aucune)"
          # Injecter les permissions après la permission INTERNET déjà présente
          sed -i 's|<uses-permission android:name="android.permission.INTERNET" />|<uses-permission android:name="android.permission.INTERNET" />\n    <uses-permission android:name="android.permission.READ_SMS" />\n    <uses-permission android:name="android.permission.RECEIVE_SMS" />\n    <uses-permission android:name="android.permission.VIBRATE" />\n    <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />|' "$M"
          echo "--- Manifest après patch ---"
          grep "permission" "$M"

      - name: Enregistrer le récepteur SMS dans le Manifest
        run: |
          M="android/app/src/main/AndroidManifest.xml"
          # Ajouter SmsReceiver avant </application>
          if ! grep -q "SmsReceiver" "$M"; then
            sed -i 's|</application>|        <receiver android:name=".SmsReceiver" android:exported="true" android:permission="android.permission.BROADCAST_SMS">\n            <intent-filter android:priority="1000">\n                <action android:name="android.provider.Telephony.SMS_RECEIVED" />\n            </intent-filter>\n        </receiver>\n    </application>|' "$M"
            echo "✅ SmsReceiver ajouté"
          else
            echo "✅ SmsReceiver déjà présent"
          fi

      - name: Build APK Debug
        run: |
          cd android && ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            -Dorg.gradle.jvmargs="-Xmx2g -XX:MaxMetaspaceSize=512m"
          echo "✅ Build Gradle terminé"

      - name: Vérification APK
        run: |
          APK="android/app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK" ]; then
            SIZE=$(du -sh "$APK" | cut -f1)
            echo "✅ APK généré — Taille : $SIZE"
          else
            echo "❌ APK introuvable"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: FamilyHub-debug-v2-${{ github.run_number }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: Résumé GitHub
        if: success()
        run: |
          APK="android/app/build/outputs/apk/debug/app-debug.apk"
          SIZE=$(du -sh "$APK" | cut -f1)
          echo "## ✅ FamilyHub APK v2 prêt" >> $GITHUB_STEP_SUMMARY
          echo "| Taille APK | $SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | #${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
