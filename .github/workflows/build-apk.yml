name: Build LockerTrack APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: "17"

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install Android build tools
      run: sdkmanager "build-tools;34.0.0" "platforms;android-34" "platform-tools"

    - name: Install npm dependencies
      run: npm install

    - name: Capacitor add android
      run: npx cap add android

    - name: Capacitor sync
      run: npx cap sync android

    - name: Copy native SMS Java files
      run: |
        DEST="android/app/src/main/java/com/mesapps/lockertrack"
        mkdir -p "$DEST"
        cp src-android/SmsReaderPlugin.java "$DEST/"
        cp src-android/MainActivity.java "$DEST/"
        echo "Java files in $DEST:"
        ls "$DEST/"

    - name: Patch AndroidManifest with SMS permissions
      run: |
        M="android/app/src/main/AndroidManifest.xml"
        if ! grep -q "READ_SMS" "$M"; then
          sed -i 's|android.permission.INTERNET"/>|android.permission.INTERNET"/>\n    <uses-permission android:name="android.permission.READ_SMS"/>\n    <uses-permission android:name="android.permission.RECEIVE_SMS"/>|' "$M"
        fi
        grep permission "$M"

    - name: Build APK
      run: |
        chmod +x android/gradlew
        cd android && ./gradlew assembleDebug --no-daemon --stacktrace

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: LockerTrack-debug-${{ github.run_number }}
        path: android/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30

    - name: Summary
      run: |
        SIZE=$(du -sh android/app/build/outputs/apk/debug/app-debug.apk | cut -f1)
        echo "## APK pret - $SIZE" >> $GITHUB_STEP_SUMMARY
        echo "Telechargez dans Artifacts ci-dessus." >> $GITHUB_STEP_SUMMARY
