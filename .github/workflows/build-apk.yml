name: Build FamilyHub APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-check:
    name: S√©curit√© & Qualit√© du code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: V√©rification s√©curit√© HTML/JS
        run: |
          echo "=== V√©rification fichiers sensibles ==="
          # V√©rifier absence de secrets cod√©s en dur
          if grep -r "password\|api_key\|secret\|token" --include="*.js" --include="*.html" .; then
            echo "‚ö†Ô∏è Potentiels secrets trouv√©s - v√©rifier manuellement"
          else
            echo "‚úÖ Aucun secret d√©tect√©"
          fi

          # V√©rifier Content Security Policy dans les HTML
          echo "=== V√©rification CSP ==="
          for f in $(find . -name "index.html" -not -path "*/node_modules/*" -not -path "*/android/*"); do
            echo "Fichier: $f"
          done

          # V√©rifier HTTPs / pas de cleartext
          echo "=== V√©rification cleartext ==="
          if grep -r "http://" --include="*.html" --include="*.js" . | grep -v "//schemas\|//www.w3\|localhost\|comment\|#"; then
            echo "‚ö†Ô∏è URLs HTTP non-s√©curis√©es d√©tect√©es"
          else
            echo "‚úÖ Toutes les URLs sont HTTPS"
          fi

      - name: V√©rification performance estim√©e
        run: |
          echo "=== Taille des fichiers HTML ==="
          for f in $(find . -name "*.html" -not -path "*/node_modules/*" -not -path "*/android/*"); do
            size=$(wc -c < "$f")
            kb=$((size / 1024))
            if [ $kb -gt 200 ]; then
              echo "‚ö†Ô∏è $f ‚Äî ${kb}KB (> 200KB, optimisation recommand√©e)"
            else
              echo "‚úÖ $f ‚Äî ${kb}KB"
            fi
          done

  build:
    name: Build APK Android
    runs-on: ubuntu-latest
    needs: security-check
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Installer outils Android
        run: |
          sdkmanager "build-tools;34.0.0" "platforms;android-34" "platform-tools"
          echo "‚úÖ Android SDK configur√©"

      - name: Installer d√©pendances npm
        run: |
          npm install --package-lock
          echo "‚úÖ npm install termin√©"

      - name: Pr√©parer le dossier www (webDir Capacitor)
        run: |
          mkdir -p www
          cp index.html www/
          cp manifest.json www/
          cp sw.js www/
          cp -r icons www/
          cp -r locker-tracker www/
          cp -r liste-courses www/
          cp -r todo-partage www/
          cp -r cave-spiritueux www/
          cp -r menus-semaine www/
          echo "‚úÖ Contenu www/ :"
          ls www/

      - name: Capacitor - Ajouter Android
        run: |
          npx cap add android || echo "Android d√©j√† pr√©sent"

      - name: Capacitor - Sync
        run: |
          npx cap sync android
          echo "‚úÖ Capacitor sync termin√©"

      - name: Copier les plugins Java natifs
        run: |
          DEST="android/app/src/main/java/com/famille/dieulgandet"
          mkdir -p "$DEST"
          cp src-android/SmsReaderPlugin.java "$DEST/"
          cp src-android/MainActivity.java "$DEST/"
          echo "‚úÖ Plugins Java copi√©s dans $DEST"
          ls "$DEST/"

      - name: Patcher AndroidManifest
        run: |
          M="android/app/src/main/AndroidManifest.xml"
          # V√©rifier et patcher permissions SMS si n√©cessaire
          if ! grep -q "READ_SMS" "$M"; then
            sed -i 's|android.permission.INTERNET\"/>|android.permission.INTERNET"/>\n    <uses-permission android:name="android.permission.READ_SMS"/>\n    <uses-permission android:name="android.permission.RECEIVE_SMS"/>|' "$M"
            echo "‚úÖ Permissions SMS ajout√©es"
          else
            echo "‚úÖ Permissions SMS d√©j√† pr√©sentes"
          fi
          grep "permission" "$M"

      - name: Build APK Debug
        run: |
          chmod +x android/gradlew
          cd android && ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            --warning-mode=all \
            -Dorg.gradle.jvmargs="-Xmx2g"
          echo "‚úÖ APK Debug compil√©"

      - name: V√©rification APK
        run: |
          APK="android/app/build/outputs/apk/debug/app-debug.apk"
          if [ -f "$APK" ]; then
            SIZE=$(du -sh "$APK" | cut -f1)
            echo "‚úÖ APK g√©n√©r√© avec succ√®s ‚Äî Taille: $SIZE"
          else
            echo "‚ùå APK non trouv√©!"
            exit 1
          fi

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: FamilyHub-debug-v2-${{ github.run_number }}
          path: android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 30

      - name: R√©sum√© GitHub
        run: |
          APK="android/app/build/outputs/apk/debug/app-debug.apk"
          SIZE=$(du -sh "$APK" | cut -f1)
          echo "## ‚úÖ FamilyHub APK v2 pr√™t" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Propri√©t√© | Valeur |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Taille APK | $SIZE |" >> $GITHUB_STEP_SUMMARY
          echo "| Build # | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ T√©l√©chargez l'APK dans l'onglet **Artifacts** ci-dessus." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Applications incluses" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ Suivi Colis (SMS + Gmail)" >> $GITHUB_STEP_SUMMARY
          echo "- üõí Liste de Courses (sync P2P)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ To-Do Partag√© (nouveau)" >> $GITHUB_STEP_SUMMARY
          echo "- üç∑ Cave & Spiritueux (nouveau)" >> $GITHUB_STEP_SUMMARY
          echo "- üçΩÔ∏è Menus de la Semaine (nouveau)" >> $GITHUB_STEP_SUMMARY
