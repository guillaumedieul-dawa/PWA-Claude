<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#080f14">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#e8f4f0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Colis">
<title>Suivi Colis</title>
<link rel="manifest" href="./manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
:root {
  --bg:#080f14;--bg2:#0d1820;--surface:#111e2a;--surface2:#172636;
  --border:rgba(0,200,160,0.12);--border2:rgba(0,200,160,0.3);
  --text:#d8eee8;--text2:#6a9e90;--text3:#1a3a30;
  --teal:#00c8a0;--blue:#0088cc;--green:#22dd88;--amber:#ffaa22;--red:#ff4455;--purple:#aa88ff;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
  --safe-left:env(safe-area-inset-left,0px);--safe-right:env(safe-area-inset-right,0px);
}
[data-theme="light"] {
  --bg:#e8f4f0;--bg2:#d4ebe3;--surface:#c4ddd5;--surface2:#b4cdc5;
  --border:rgba(0,100,80,0.15);--border2:rgba(0,100,80,0.3);
  --text:#042018;--text2:#1a6050;--text3:#88c0b0;
  --teal:#007a60;--blue:#005599;--green:#116644;--amber:#996600;--red:#cc1122;--purple:#5533aa;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html{height:100%}
body{
  font-family:'Rajdhani',sans-serif;
  background:var(--bg);color:var(--text);
  min-height:100dvh;overflow-x:hidden;
  transition:background 0.3s,color 0.3s;
}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(var(--border) 1px,transparent 1px),linear-gradient(90deg,var(--border) 1px,transparent 1px);background-size:40px 40px;pointer-events:none;z-index:0;opacity:0.35}
body::after{content:'';position:fixed;top:-20vh;right:-10%;width:70vw;height:60vh;background:radial-gradient(ellipse,rgba(0,200,160,0.07) 0%,transparent 70%);pointer-events:none;z-index:0}
#app{position:relative;z-index:1;min-height:100dvh;display:flex;flex-direction:column;
  padding:calc(var(--safe-top) + 12px) calc(var(--safe-right) + 16px) calc(var(--safe-bot) + 80px) calc(var(--safe-left) + 16px);
  max-width:520px;margin:0 auto;width:100%}

/* â”€â”€ Top bar â”€â”€ */
.top-bar{display:flex;align-items:center;gap:10px;margin-bottom:20px;animation:fadeDown 0.4s ease both}
.btn-home{width:38px;height:38px;border-radius:10px;border:1px solid var(--border2);background:var(--surface);color:var(--text2);font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;text-decoration:none;flex-shrink:0}
.btn-home:active{transform:scale(0.88);background:var(--surface2)}
.top-title{flex:1;min-width:0}
.top-eyebrow{font-family:'Share Tech Mono',monospace;font-size:9px;letter-spacing:3px;text-transform:uppercase;color:var(--teal);opacity:0.8}
.top-name{font-family:'Josefin Sans',sans-serif;font-size:21px;font-weight:700;text-transform:uppercase;letter-spacing:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.btn-icon{width:38px;height:38px;border-radius:10px;border:1px solid var(--border2);background:var(--surface);color:var(--text2);font-size:17px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;flex-shrink:0}
.btn-icon:active{transform:scale(0.88)}
.btn-icon.pulse{animation:pulse 2s infinite}

/* â”€â”€ Filters â”€â”€ */
.filter-row{display:flex;gap:6px;margin-bottom:16px;animation:fadeUp 0.4s 0.05s ease both;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.ftab{flex-shrink:0;padding:8px 14px;border-radius:20px;font-family:'Josefin Sans',sans-serif;font-size:12px;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;border:1px solid var(--border);background:var(--surface);color:var(--text2);cursor:pointer;transition:all 0.2s;white-space:nowrap}
.ftab.active{border-color:var(--teal);color:var(--teal);background:rgba(0,200,160,0.1)}
.ftab:active{transform:scale(0.94)}
.badge{display:inline-block;background:var(--teal);color:#fff;border-radius:10px;font-size:10px;font-family:'Share Tech Mono',monospace;padding:1px 6px;margin-left:5px;vertical-align:middle}
.badge.amber{background:var(--amber)}
.badge.red{background:var(--red)}

/* â”€â”€ Package cards â”€â”€ */
.pkg-list{display:flex;flex-direction:column;gap:12px;animation:fadeUp 0.4s 0.1s ease both}
.pkg-card{background:var(--surface);border:1px solid var(--border);border-radius:16px;overflow:hidden;transition:all 0.25s;cursor:pointer}
.pkg-card:active{transform:scale(0.98)}
.pkg-card.expanded{border-color:var(--border2)}
.pkg-header{padding:14px 16px;display:flex;align-items:center;gap:12px}
.carrier-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.carrier-name{font-family:'Josefin Sans',sans-serif;font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.status-pill{padding:4px 10px;border-radius:20px;font-family:'Share Tech Mono',monospace;font-size:10px;font-weight:700;letter-spacing:0.5px;white-space:nowrap;flex-shrink:0}
.s-ready{background:rgba(0,200,160,0.15);color:var(--teal);border:1px solid rgba(0,200,160,0.3)}
.s-pending{background:rgba(255,170,34,0.15);color:var(--amber);border:1px solid rgba(255,170,34,0.3)}
.s-delivered{background:rgba(34,221,136,0.12);color:var(--green);border:1px solid rgba(34,221,136,0.3)}
.s-expired{background:rgba(255,68,85,0.12);color:var(--red);border:1px solid rgba(255,68,85,0.3)}
.s-collected{background:rgba(255,255,255,0.06);color:var(--text2);border:1px solid var(--border)}

.pkg-body{padding:0 16px 14px;border-top:1px solid var(--border)}
.pkg-row{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap}
.pkg-field{flex:1;min-width:120px}
.field-label{font-family:'Share Tech Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:3px}
.field-val{font-size:14px;font-weight:600;word-break:break-all}
.field-val.mono{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:1px;color:var(--teal)}
.pkg-addr{margin-top:10px;padding:10px;background:var(--bg2);border-radius:10px;font-size:13px;line-height:1.5}
.pkg-code-box{margin-top:10px;padding:12px 16px;background:rgba(0,200,160,0.08);border:1px solid var(--border2);border-radius:12px;text-align:center}
.code-label{font-family:'Share Tech Mono',monospace;font-size:9px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:6px}
.code-val{font-family:'Share Tech Mono',monospace;font-size:28px;font-weight:700;color:var(--teal);letter-spacing:4px}
.code-sub{font-size:12px;color:var(--text2);margin-top:4px}
.pkg-actions{display:flex;gap:8px;margin-top:12px}
.act-btn{flex:1;padding:9px 8px;border-radius:10px;font-family:'Josefin Sans',sans-serif;font-size:12px;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;border:1px solid var(--border2);background:transparent;color:var(--text2);cursor:pointer;transition:all 0.2s;text-align:center;text-decoration:none;display:flex;align-items:center;justify-content:center;gap:5px}
.act-btn.primary{background:rgba(0,200,160,0.15);color:var(--teal);border-color:rgba(0,200,160,0.4)}
.act-btn.danger{background:rgba(255,68,85,0.08);color:var(--red);border-color:rgba(255,68,85,0.3)}
.act-btn:active{transform:scale(0.94)}
.expiry-bar{height:3px;border-radius:2px;background:var(--surface2);margin-top:12px;overflow:hidden}
.expiry-fill{height:100%;border-radius:2px;transition:width 0.5s ease}

/* â”€â”€ Empty state â”€â”€ */
.empty{text-align:center;padding:60px 20px;animation:fadeUp 0.5s ease both}
.empty-icon{font-size:56px;margin-bottom:16px;filter:grayscale(0.3)}
.empty-title{font-family:'Josefin Sans',sans-serif;font-size:20px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.empty-sub{font-size:14px;color:var(--text2);line-height:1.5}

/* â”€â”€ FAB â”€â”€ */
.fab{position:fixed;bottom:calc(var(--safe-bot) + 24px);right:24px;width:56px;height:56px;border-radius:18px;background:linear-gradient(135deg,var(--teal),var(--blue));border:none;color:#fff;font-size:26px;cursor:pointer;z-index:50;box-shadow:0 4px 20px rgba(0,200,160,0.4);display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.fab:active{transform:scale(0.9)}

/* â”€â”€ Modal â”€â”€ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:200;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.3s}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--bg2);border-radius:24px 24px 0 0;padding:20px 20px calc(var(--safe-bot) + 20px);width:100%;max-width:520px;max-height:90dvh;overflow-y:auto;transform:translateY(100%);transition:transform 0.35s cubic-bezier(.32,1,.23,1)}
.modal-overlay.open .modal{transform:translateY(0)}
.modal-handle{width:36px;height:4px;background:var(--border2);border-radius:2px;margin:0 auto 20px;cursor:pointer}
.modal-title{font-family:'Josefin Sans',sans-serif;font-size:18px;font-weight:700;text-transform:uppercase;letter-spacing:1px;margin-bottom:20px}
.section-label{font-family:'Share Tech Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text2);margin-bottom:8px;margin-top:20px}
.section-label:first-child{margin-top:0}
.form-input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border2);background:var(--surface);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:500;transition:border-color 0.2s}
.form-input:focus{outline:none;border-color:var(--teal)}
.form-input::placeholder{color:var(--text2)}
textarea.form-input{resize:vertical;min-height:80px;font-family:'Share Tech Mono',monospace;font-size:12px}
.form-select{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--border2);background:var(--surface);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:500;appearance:none}
.carrier-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.carrier-btn{padding:12px 8px;border-radius:12px;border:1px solid var(--border);background:var(--surface);cursor:pointer;text-align:center;transition:all 0.2s;font-family:'Josefin Sans',sans-serif;font-size:11px;font-weight:700;letter-spacing:0.3px;color:var(--text2)}
.carrier-btn .cem{font-size:22px;display:block;margin-bottom:4px}
.carrier-btn.selected{border-color:var(--teal);color:var(--teal);background:rgba(0,200,160,0.1)}
.carrier-btn:active{transform:scale(0.94)}
.btn-submit{width:100%;padding:14px;border-radius:14px;background:linear-gradient(135deg,var(--teal),var(--blue));border:none;color:#fff;font-family:'Josefin Sans',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;margin-top:4px}
.btn-submit:active{transform:scale(0.97)}
.btn-secondary{width:100%;padding:12px;border-radius:14px;background:transparent;border:1px solid var(--border2);color:var(--text2);font-family:'Josefin Sans',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;text-transform:uppercase;cursor:pointer;transition:all 0.2s;margin-top:8px}
.btn-secondary:active{transform:scale(0.97)}
.form-row{display:flex;gap:10px}
.form-row .form-input{flex:1}

/* â”€â”€ Gmail Panel â”€â”€ */
.gmail-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:14px;margin-bottom:12px}
.gmail-account{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.gmail-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--teal),var(--blue));display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;font-family:'Josefin Sans',sans-serif;font-weight:700;color:#fff}
.gmail-info{flex:1;min-width:0}
.gmail-name{font-family:'Josefin Sans',sans-serif;font-size:14px;font-weight:700;text-transform:uppercase}
.gmail-email{font-size:12px;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.gmail-status{display:inline-flex;align-items:center;gap:5px;font-family:'Share Tech Mono',monospace;font-size:10px;padding:3px 8px;border-radius:10px;margin-top:3px}
.gmail-status.connected{background:rgba(0,200,160,0.1);color:var(--teal)}
.gmail-status.disconnected{background:rgba(255,255,255,0.06);color:var(--text2)}
.oauth-info{background:rgba(0,200,160,0.06);border:1px solid rgba(0,200,160,0.15);border-radius:10px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--text2);line-height:1.6}
.oauth-info a{color:var(--teal)}
.oauth-steps{counter-reset:step;margin:8px 0}
.oauth-steps li{counter-increment:step;list-style:none;padding-left:20px;position:relative;margin-bottom:6px;font-size:12px;color:var(--text2)}
.oauth-steps li::before{content:counter(step);position:absolute;left:0;top:1px;width:14px;height:14px;background:var(--teal);color:#fff;border-radius:50%;font-size:9px;display:flex;align-items:center;justify-content:center;font-family:'Share Tech Mono',monospace}
.token-input-wrap{position:relative}
.token-input-wrap .form-input{padding-right:44px;font-family:'Share Tech Mono',monospace;font-size:11px}
.token-eye{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--text2);cursor:pointer;font-size:16px;padding:4px}

/* â”€â”€ SMS area â”€â”€ */
.sms-textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border2);background:var(--surface);color:var(--text);font-family:'Share Tech Mono',monospace;font-size:12px;min-height:100px;resize:vertical}
.sms-textarea:focus{outline:none;border-color:var(--teal)}
.sms-textarea::placeholder{color:var(--text2)}

/* â”€â”€ Search â”€â”€ */
.search-wrap{position:relative;margin-bottom:14px;animation:fadeDown 0.4s 0.03s ease both}
.search-input{width:100%;padding:11px 14px 11px 40px;border-radius:12px;border:1px solid var(--border);background:var(--surface);color:var(--text);font-family:'Rajdhani',sans-serif;font-size:15px;font-weight:500}
.search-input:focus{outline:none;border-color:var(--teal)}
.search-icon{position:absolute;left:13px;top:50%;transform:translateY(-50%);color:var(--text2);font-size:16px;pointer-events:none}

/* â”€â”€ Toast â”€â”€ */
.toast{position:fixed;bottom:calc(var(--safe-bot) + 96px);left:50%;transform:translateX(-50%) translateY(30px);background:var(--surface2);border:1px solid var(--border2);color:var(--text);padding:10px 18px;border-radius:12px;font-size:13px;font-family:'Josefin Sans',sans-serif;font-weight:600;z-index:999;opacity:0;transition:all 0.3s;white-space:nowrap;max-width:90vw}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

/* â”€â”€ Sync progress â”€â”€ */
.sync-bar{height:2px;background:var(--surface2);border-radius:1px;overflow:hidden;margin-bottom:8px}
.sync-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--teal),var(--blue));border-radius:1px;transition:width 0.1s linear}

/* â”€â”€ QR modal â”€â”€ */
#qrModal .modal{padding-bottom:calc(var(--safe-bot) + 24px)}
.qr-wrap{text-align:center;padding:20px 0}
.qr-wrap canvas,.qr-wrap img{border-radius:12px;max-width:200px}

/* â”€â”€ Animations â”€â”€ */
@keyframes fadeDown{from{opacity:0;transform:translateY(-12px)}to{opacity:1;transform:none}}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:none}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.5}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes shimmer{from{background-position:200% 0}to{background-position:-200% 0}}

/* â”€â”€ Dark mode toggle â”€â”€ */
[data-theme="light"] body::after{background:radial-gradient(ellipse,rgba(0,100,80,0.06) 0%,transparent 70%)}

/* â”€â”€ Pull-to-refresh indicator â”€â”€ */
.ptr-indicator{text-align:center;padding:8px;font-size:12px;color:var(--text2);height:0;overflow:hidden;transition:height 0.2s}
</style>
</head>
<body>
<div id="app">
  <div class="top-bar">
    <a href="../index.html" class="btn-home" title="Accueil">ğŸ </a>
    <div class="top-title">
      <div class="top-eyebrow">FAMILLE DIEUL-GANDET</div>
      <div class="top-name">ğŸ“¦ Suivi Colis</div>
    </div>
    <button class="btn-icon" onclick="openSync()" title="Synchroniser" id="mainSyncBtn">âŸ³</button>
    <button class="btn-icon" onclick="toggleTheme()" id="themeBtn" title="ThÃ¨me">ğŸŒ™</button>
  </div>

  <div class="search-wrap">
    <span class="search-icon">ğŸ”</span>
    <input class="search-input" placeholder="Rechercher un colis, transporteurâ€¦" oninput="filterPackages(this.value)" id="searchInput">
  </div>

  <div class="filter-row" id="filterRow">
    <button class="ftab active" onclick="setFilter('all',this)">Tous <span class="badge" id="badgeAll">0</span></button>
    <button class="ftab" onclick="setFilter('ready',this)">Ã€ retirer <span class="badge amber" id="badgeReady">0</span></button>
    <button class="ftab" onclick="setFilter('pending',this)">En route <span class="badge" id="badgePending">0</span></button>
    <button class="ftab" onclick="setFilter('delivered',this)">LivrÃ© <span class="badge" id="badgeDelivered">0</span></button>
    <button class="ftab" onclick="setFilter('expired',this)">ExpirÃ© <span class="badge red" id="badgeExpired">0</span></button>
  </div>

  <div class="pkg-list" id="pkgList"></div>

  <button class="fab" onclick="openAddModal()" title="Ajouter un colis">ï¼‹</button>
</div>

<div class="toast" id="toast"></div>

<!-- â”€â”€ Modal Ajout â”€â”€ -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-handle" onclick="closeModal('addModal')"></div>
    <div class="modal-title">â• Ajouter un colis</div>

    <div class="section-label">Transporteur</div>
    <div class="carrier-grid" id="carrierGrid">
      <div class="carrier-btn" onclick="selectCarrier('chronopost',this)"><span class="cem">ğŸ”µ</span>Chronopost</div>
      <div class="carrier-btn" onclick="selectCarrier('colissimo',this)"><span class="cem">ğŸŸ¡</span>Colissimo</div>
      <div class="carrier-btn" onclick="selectCarrier('mondialrelay',this)"><span class="cem">ğŸ”´</span>Mondial Relay</div>
      <div class="carrier-btn" onclick="selectCarrier('dpd',this)"><span class="cem">ğŸ”¶</span>DPD</div>
      <div class="carrier-btn" onclick="selectCarrier('ups',this)"><span class="cem">ğŸŸ¤</span>UPS</div>
      <div class="carrier-btn" onclick="selectCarrier('gls',this)"><span class="cem">ğŸŸ¢</span>GLS</div>
      <div class="carrier-btn" onclick="selectCarrier('relaiscolis',this)"><span class="cem">ğŸŸ </span>Relais Colis</div>
      <div class="carrier-btn" onclick="selectCarrier('vintedgo',this)"><span class="cem">ğŸ’š</span>Vinted Go</div>
      <div class="carrier-btn" onclick="selectCarrier('laposte',this)"><span class="cem">ğŸŸ¡</span>La Poste</div>
      <div class="carrier-btn" onclick="selectCarrier('amazon',this)"><span class="cem">ğŸŸ </span>Amazon</div>
      <div class="carrier-btn" onclick="selectCarrier('chronofresh',this)"><span class="cem">â„ï¸</span>Chronofresh</div>
      <div class="carrier-btn" onclick="selectCarrier('other',this)"><span class="cem">ğŸ“¦</span>Autre</div>
    </div>

    <div class="form-row">
      <div style="flex:1">
        <div class="section-label">NÂ° de suivi</div>
        <input class="form-input" id="addTracking" placeholder="Ex: 1ZA2E708â€¦">
      </div>
      <div style="flex:1">
        <div class="section-label">Code retrait</div>
        <input class="form-input" id="addCode" placeholder="Ex: 6684">
      </div>
    </div>

    <div class="section-label">Lieu de retrait / Adresse livraison</div>
    <input class="form-input" id="addAddress" placeholder="Consigne Pickup Grand Frais Herblayâ€¦" style="margin-bottom:10px">

    <div class="form-row">
      <div style="flex:1">
        <div class="section-label">Destinataire</div>
        <select class="form-select" id="addAccount">
          <option value="1">Guillaume</option>
          <option value="2">MichÃ¨le</option>
        </select>
      </div>
      <div style="flex:1">
        <div class="section-label">Date limite</div>
        <input class="form-input" type="date" id="addExpiry">
      </div>
    </div>

    <div class="section-label">Note (optionnel)</div>
    <input class="form-input" id="addNote" placeholder="Amazon â€” chemise bleueâ€¦" style="margin-bottom:16px">

    <button class="btn-submit" onclick="addPackage()">âœ“ Enregistrer</button>
    <button class="btn-secondary" onclick="closeModal('addModal')">Annuler</button>
  </div>
</div>

<!-- â”€â”€ Modal Sync / Gmail â”€â”€ -->
<div class="modal-overlay" id="syncModal">
  <div class="modal">
    <div class="modal-handle" onclick="closeModal('syncModal')"></div>
    <div class="modal-title">âŸ³ Synchronisation</div>

    <!-- Gmail Account 1 -->
    <div class="section-label">Compte Gmail â€” Guillaume</div>
    <div class="gmail-card">
      <div class="gmail-account">
        <div class="gmail-avatar" id="av1">G</div>
        <div class="gmail-info">
          <div class="gmail-name" id="name1">Guillaume Dieul</div>
          <div class="gmail-email" id="email1">guillaume.dieul@gmail.com</div>
          <div class="gmail-status disconnected" id="status1">â¬¤ Non connectÃ©</div>
        </div>
        <button class="btn-icon" onclick="disconnectAccount(1)" id="disc1" style="display:none" title="DÃ©connecter">âœ•</button>
      </div>
      <div class="sync-bar"><div class="sync-fill" id="progress1"></div></div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px" id="acc1syncResult"></div>
      <div style="display:flex;gap:8px">
        <button class="btn-submit" style="margin-top:0;flex:1" onclick="openOAuthBrowser(1)" id="acc1connectBtn">ğŸ”— Connecter</button>
        <button class="btn-submit" style="margin-top:0;flex:1;background:rgba(0,200,160,0.15);color:var(--teal);border:1px solid rgba(0,200,160,0.3)" onclick="syncAccount(1)" id="syncBtn1">âŸ³ Sync</button>
      </div>
    </div>

    <!-- Gmail Account 2 -->
    <div class="section-label">Compte Gmail â€” MichÃ¨le</div>
    <div class="gmail-card">
      <div class="gmail-account">
        <div class="gmail-avatar" id="av2" style="background:linear-gradient(135deg,var(--purple),var(--blue))">M</div>
        <div class="gmail-info">
          <div class="gmail-name" id="name2">MichÃ¨le Gandet</div>
          <div class="gmail-email" id="email2">michele.gandet@gmail.com</div>
          <div class="gmail-status disconnected" id="status2">â¬¤ Non connectÃ©</div>
        </div>
        <button class="btn-icon" onclick="disconnectAccount(2)" id="disc2" style="display:none" title="DÃ©connecter">âœ•</button>
      </div>
      <div class="sync-bar"><div class="sync-fill" id="progress2"></div></div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px" id="acc2syncResult"></div>
      <div style="display:flex;gap:8px">
        <button class="btn-submit" style="margin-top:0;flex:1" onclick="openOAuthBrowser(2)" id="acc2connectBtn">ğŸ”— Connecter</button>
        <button class="btn-submit" style="margin-top:0;flex:1;background:rgba(0,200,160,0.15);color:var(--teal);border:1px solid rgba(0,200,160,0.3)" onclick="syncAccount(2)" id="syncBtn2">âŸ³ Sync</button>
      </div>
    </div>

    <!-- Comment connecter -->
    <div class="section-label">Comment connecter ?</div>
    <div class="oauth-info">
      La connexion Google s'ouvre dans votre navigateur par dÃ©faut.<br>
      <ol class="oauth-steps" style="margin-top:8px">
        <li>Appuyez sur <b>Connecter</b> â†’ Chrome s'ouvre</li>
        <li>Autorisez l'accÃ¨s Ã  votre Gmail</li>
        <li>Copiez le code affichÃ© et revenez ici</li>
        <li>Collez-le dans le champ ci-dessous et validez</li>
      </ol>
    </div>

    <div class="section-label">Coller le code de connexion</div>
    <div class="form-row" style="margin-bottom:12px">
      <select class="form-select" id="tokenAccountSelect" style="flex:0 0 120px">
        <option value="1">Guillaume</option>
        <option value="2">MichÃ¨le</option>
      </select>
      <div class="token-input-wrap" style="flex:1">
        <input class="form-input" id="tokenInput" placeholder="Collez le token iciâ€¦" type="password">
        <button class="token-eye" onclick="toggleTokenVis()">ğŸ‘</button>
      </div>
    </div>
    <button class="btn-submit" onclick="saveManualToken()" style="margin-bottom:16px">âœ“ Valider le token</button>

    <div class="modal-handle" style="margin:0 auto 12px"></div>

    <!-- SMS -->
    <div class="section-label">ğŸ“± Coller un SMS transporteur</div>
    <textarea class="sms-textarea" id="smsInput" placeholder="Collez votre SMS iciâ€¦
Ex: Vos codes 6684 puis 7785 pour retirer votre colis Colissimo disponible en Consigne Pickup Grand Frais Herblay...
Ex: Votre colis 00IZ31TJ de LA PLANTE DU LOUP est en route avec GLS...
Ex: Retire ton colis avant le 2024-12-24. Code: G2-6949. Consigne Vinted Go: Maxi Bazar Herblay..."></textarea>
    <button class="btn-submit" onclick="parseSMSManual()" style="margin-top:8px;margin-bottom:8px">ğŸ“² Extraire depuis SMS</button>
    <button class="btn-secondary" onclick="closeModal('syncModal')">Fermer</button>
  </div>
</div>

<!-- â”€â”€ Modal QR Code â”€â”€ -->
<div class="modal-overlay" id="qrModal">
  <div class="modal" style="text-align:center">
    <div class="modal-handle" onclick="closeModal('qrModal')"></div>
    <div class="modal-title" id="qrTitle">QR Code</div>
    <div class="qr-wrap" id="qrContainer"></div>
    <div style="font-family:'Share Tech Mono',monospace;font-size:13px;color:var(--text2);margin-bottom:16px" id="qrValue"></div>
    <button class="btn-secondary" onclick="closeModal('qrModal')">Fermer</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTES & CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STORAGE_KEY = 'lockertrack_v2';
const OAUTH_URL = 'https://accounts.google.com/o/oauth2/v2/auth';
const GMAIL_SCOPE = 'https://www.googleapis.com/auth/gmail.readonly';
const CLIENT_ID = '528916029188-s5gm9iq21hc7pu07brvng1vq221ch9i9.apps.googleusercontent.com'; // Ã€ configurer si besoin, sinon mode token manuel

// DurÃ©e de conservation par dÃ©faut (jours)
const CARRIER_RETENTION = {
  chronopost:8, chronofresh:5, mondialrelay:14, colissimo:15,
  laposte:15, vintedgo:14, amazon:3, dpd:14, ups:10, gls:7,
  relaiscolis:10, other:14
};

// Couleurs par transporteur
const CARRIER_COLORS = {
  chronopost:'#003087', chronofresh:'#005fa3', mondialrelay:'#e2001a',
  colissimo:'#ffd700', laposte:'#ffd700', vintedgo:'#09b1ba',
  amazon:'#ff9900', dpd:'#dc0032', ups:'#351c15', gls:'#005ca9',
  relaiscolis:'#e8621a', other:'#6a9e90'
};

const CARRIER_LABELS = {
  chronopost:'Chronopost', chronofresh:'Chronofresh', mondialrelay:'Mondial Relay',
  colissimo:'Colissimo', laposte:'La Poste', vintedgo:'Vinted Go',
  amazon:'Amazon', dpd:'DPD', ups:'UPS', gls:'GLS',
  relaiscolis:'Relais Colis', other:'Autre'
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DONNÃ‰ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadData() {
  try {
    const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
    if (d?.packages) return d;
  } catch {}
  return getDefaultData();
}

function saveData(d) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(d));
}

function getDefaultData() {
  return {
    packages: [], accounts: {
      1: { name:'Guillaume Dieul', email:'guillaume.dieul@gmail.com', lastSync:null },
      2: { name:'MichÃ¨le Gandet', email:'michele.gandet@gmail.com', lastSync:null }
    }, nextId:1
  };
}

let appData = loadData();
let currentFilter = 'all';
let currentSearch = '';
let selectedCarrier = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DÃ‰TECTION TRANSPORTEUR (emails + SMS)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CARRIER_DETECTORS = [
  // Chronofresh avant Chronopost (plus spÃ©cifique)
  { c:'chronofresh', test:(f,s,b) => /chronofresh/i.test(f+s+b) },
  // Colissimo avant La Poste
  { c:'colissimo',   test:(f,s,b) => /colissimo/i.test(f+s+b) },
  // Chronopost
  { c:'chronopost',  test:(f,s,b) => /chronopost/i.test(f+s+b) || /pickup\.fr/i.test(f) },
  // Mondial Relay
  { c:'mondialrelay',test:(f,s,b) => /mondial.?relay/i.test(f+s+b) || /point relais/i.test(b) },
  // Vinted Go
  { c:'vintedgo',    test:(f,s,b) => /vinted/i.test(f+s+b) },
  // Relais Colis
  { c:'relaiscolis', test:(f,s,b) => /relais.?colis/i.test(f+s+b) || /relaiscolis/i.test(f) },
  // Amazon
  { c:'amazon',      test:(f,s,b) => /amazon/i.test(f+s+b) && !/chronopost|mondial/i.test(f+s) },
  // DPD
  { c:'dpd',         test:(f,s,b) => /\bdpd\b/i.test(f+s+b) || /dpdgroup/i.test(f) },
  // UPS
  { c:'ups',         test:(f,s,b) => /\bups\b/i.test(f+s+b) || /mcinfo@ups/i.test(f) },
  // GLS
  { c:'gls',         test:(f,s,b) => /\bgls\b/i.test(f+s+b) || /gls-france/i.test(f+s+b) },
  // La Poste gÃ©nÃ©rique
  { c:'laposte',     test:(f,s,b) => /la.?poste/i.test(f+s+b) || /laposte/i.test(f) },
];

// Statuts â€” ordre prioritÃ© : delivered > expired > ready > pending
const STATUS_MAP = {
  delivered:['votre colis a Ã©tÃ© livrÃ©','colis livrÃ©','livrÃ© Ã ','a Ã©tÃ© livrÃ©','livraison effectuÃ©e','delivered','remis Ã '],
  expired:  ['retournÃ© Ã  l\'expÃ©diteur','non rÃ©cupÃ©rÃ©','renvoyÃ©','dÃ©lai dÃ©passÃ©','retour expÃ©diteur','expirÃ©'],
  ready:    ['disponible en consigne','disponible dans votre','Ã  retirer','Ã  rÃ©cupÃ©rer','est arrivÃ© dans','est disponible',
             'vous pouvez retirer','vos codes','code de retrait','code:','retire ton colis','colis disponible',
             'attend dans votre point','dans votre relais','dÃ©posÃ© dans'],
  pending:  ['en chemin','en cours de livraison','en route','en transit','expÃ©diÃ©','pris en charge','acheminÃ©',
             'sera livrÃ©','sera disponible','out for delivery','in transit','est en route','confiÃ© par'],
};

function detectStatus(text) {
  const lo = text.toLowerCase();
  for (const [st, kws] of Object.entries(STATUS_MAP)) {
    if (kws.some(kw => lo.includes(kw))) return st;
  }
  return 'pending';
}

// â”€â”€ Extraction nÂ° de suivi â”€â”€
function extractTracking(carrier, text) {
  const patterns = {
    // UPS: 1Z + 16 alphanum
    ups:         [/\b(1Z[A-Z0-9]{16})\b/i],
    // Chronopost / Chronofresh: 2L+9N+2L ou XU+...
    chronopost:  [/\b([A-Z]{2}\d{9}[A-Z]{2})\b/, /\b(PP\d{9}FR)\b/i],
    chronofresh: [/\b([A-Z]{2}\d{9}[A-Z]{2})\b/, /n[Â°o]\s*([A-Z0-9]{10,15})/i],
    // Colissimo: 6M... ou 8X... ou alphanum 11-15
    colissimo:   [/\bn[Â°o]\s*([A-Z0-9]{9,15})\b/i, /\b(6[A-Z]\d{11})\b/, /\b(8[A-Z]\d{11})\b/],
    // Mondial Relay: 5-10 chiffres
    mondialrelay:[/votre colis\s+(\d{5,10})\b/i, /\b(\d{8})\b/],
    // Vinted Go: 1UW..., 173..., 176...
    vintedgo:    [/\b(1UW[A-Z0-9]{9,})\b/i, /\b(\d{16,19})\b/, /suivi\s*:\s*([A-Z0-9]{8,})/i],
    // DPD: 14 chiffres ou alphanum
    dpd:         [/\b(\d{14})\b/, /n[Â°o][^:\n]{0,10}:\s*([0-9A-Z]{10,14})/i, /colis n[Â°o]\s*([0-9]{10,})/i],
    // GLS: 8 alphanum (ex: 00IZ31TJ, 00J1TB8E)
    gls:         [/\b([0-9A-Z]{8})\b(?:\s+(?:de|est))/i, /colis\s+([0-9A-Z]{6,10})\b/i],
    // Relais Colis: VD... ou alphanum
    relaiscolis: [/\b(VD[A-Z0-9]{8,})\b/i, /rÃ©fÃ©rence\s+colis[^:]*:\s*([A-Z0-9\s]+?)(?:\n|$)/i],
    // La Poste
    laposte:     [/\bn[Â°o]\s*([A-Z0-9]{9,15})\b/i],
    amazon:      [/\b(\d{3}-\d{7}-\d{7})\b/],
  };
  for (const re of (patterns[carrier] || [/\b([A-Z0-9]{8,20})\b/])) {
    const m = text.match(re);
    if (m?.[1]?.length >= 5) return m[1].toUpperCase().trim();
  }
  return '';
}

// â”€â”€ Extraction code retrait â”€â”€
// GÃ¨re: "code: 1234", "codes 6684 puis 7785", "Code: G2-6949", "Identifiant: 5241 / Code d'ouverture: 9491"
function extractPickupCode(text) {
  const patterns = [
    // "codes 6684 puis 7785" â†’ "6684 / 7785"
    /vos codes\s+(\d{4})\s+puis\s+(\d{4})/i,
    // "Code d'ouverture : 9491" et "Identifiant : 5241"
    /identifiant\s*:\s*(\d{3,8}).*?code\s*d['']ouverture\s*:\s*(\d{3,8})/is,
    // Code: G2-6949
    /\bcode\s*:\s*([A-Z0-9\-]{3,12})/i,
    // code de retrait : 653188
    /code\s*(?:d[e']\s*)?(?:retrait|ouverture|accÃ¨s)\s*[:\s]+([A-Z0-9]{4,12})/i,
    // NumÃ©ro/code standard
    /\bcode\b\s*:?\s*([0-9]{4,8})\b/i,
    // PIN
    /\bpin\b\s*[:\s]+([0-9]{4,8})\b/i,
  ];
  for (const re of patterns) {
    const m = text.match(re);
    if (m) {
      if (m[2]) return m[1] + ' / ' + m[2]; // double code
      if (m[1]) return m[1].toUpperCase();
    }
  }
  return '';
}

// â”€â”€ Extraction adresse â”€â”€
function extractAddress(carrier, text) {
  // Patterns spÃ©cifiques par transporteur
  const specific = [
    // Colissimo / La Poste : "Votre point de retrait :\n\nNOM\nRUE\nCP VILLE"
    /votre\s+point\s+de\s+retrait\s*:?\s*\n+(.+?\n.+?\n.+?)(?:\n\n|\nfacilitez|\nrenseignez)/is,
    // Consigne Pickup Chronopost : "Consigne Pickup Grand Frais Herblay\n16 AVENUE..."
    /consigne\s+pickup\s+(.+?)(?:\n|\.|jusqu)/i,
    // Chronopost : "disponible en consigne Pickup NOM VILLE"
    /consigne\s+pickup\s+(.+?)(?:\.|jusqu|$)/i,
    // Mondial Relay "Votre Point RelaisÂ® de dÃ©pÃ´t\nNOM\nRUE\nCP VILLE"
    /votre\s+point\s+relaisÂ®?\s+(?:de\s+)?(?:dÃ©pÃ´t|livraison|retrait)?\s*\n(.+?\n.+?\n.+?)(?:\n\n|ce message)/is,
    // "Point RelaisÂ® :\nNOM"
    /point\s+relaisÂ®?\s*[:\n]\s*(.+?)(?:\n\n|infos|merci)/is,
    // Vinted Go Consigne : "Consigne Vinted Go: Maxi Bazar Herblay, 2 avenue..."
    /consigne\s+vinted\s+go\s*:\s*(.+?)(?:\.|suivi|$)/i,
    // Relais Colis : "dans votre Relais PIERRELAYE EXO"
    /dans\s+(?:votre\s+)?(?:relais|point)\s+(.+?)(?:\.|jusqu|$)/i,
    // UPS adresse "ExpÃ©dier Ã \nNOM\nRUE\nVILLE"
    /expÃ©dier Ã \s*\n(.+?\n.+?\n.+?)(?:\n\n|ups standard)/is,
    // DPD "Sera livrÃ© Ã \nNOM\nRUE"
    /sera\s+livrÃ©\s+Ã \s*\n(.+?\n.+?)(?:\n\n|france|voir)/is,
    // GÃ©nÃ©rique
    /(?:adresse|locker|consigne|pickup)\s*[:\n]\s*([^\n]{5,80}(?:\n[^\n]{3,60}){0,2})/i,
  ];
  const JUNK = /^(ce message|merci|suivre|tÃ©lÃ©chargez|retrouvez|pour en|bonjour|facilitez|donnÃ©es|mentions|www\.|aidez|cette|chronopost|colissimo)/i;
  for (const re of specific) {
    const m = text.match(re);
    if (m?.[1]) {
      const lines = m[1].split('\n').map(l=>l.trim()).filter(l=>l.length>2 && !JUNK.test(l));
      if (lines.length>0) return lines.slice(0,4).join(', ').replace(/,\s*,/g,',').trim();
    }
  }
  return '';
}

// â”€â”€ Extraction date expiration â”€â”€
function extractExpiry(text, arrivalDate, carrier) {
  // "disposez de 8 jours" / "5 jours" / "8 jours"
  const durM = text.match(/(?:disposez?\s+de|pendant)\s+(\d+)\s+jours?/i);
  if (durM) { const d=new Date(arrivalDate); d.setDate(d.getDate()+parseInt(durM[1])); return d.toISOString().split('T')[0]; }
  // "retirer avant le 2024-12-24" (format ISO)
  const isoM = text.match(/(?:avant le|jusqu['']au)\s+(\d{4}-\d{2}-\d{2})/i);
  if (isoM) return isoM[1];
  // "jusqu'au 12 janvier 2026" / "avant le 15/02/2025"
  const MONTHS = {janvier:1,fÃ©vrier:2,mars:3,avril:4,mai:5,juin:6,juillet:7,aoÃ»t:8,septembre:9,octobre:10,novembre:11,dÃ©cembre:12};
  const txtM = text.match(/(?:jusqu['']au|avant le)\s+(\d{1,2})\s+([a-zÃ©]+)\s+(\d{4})/i);
  if (txtM) {
    const mo = MONTHS[txtM[2].toLowerCase()];
    if (mo) return `${txtM[3]}-${String(mo).padStart(2,'0')}-${txtM[1].padStart(2,'0')}`;
  }
  // "jusqu'au 15/01" ou "24/01/25"
  const numM = text.match(/(?:jusqu['']au|avant le)\s+(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/i);
  if (numM) {
    const y = numM[3] ? (numM[3].length===2?'20'+numM[3]:numM[3]) : new Date().getFullYear();
    return `${y}-${numM[2].padStart(2,'0')}-${numM[1].padStart(2,'0')}`;
  }
  // Fallback durÃ©e standard
  const days = CARRIER_RETENTION[carrier]||14;
  const def = new Date(arrivalDate); def.setDate(def.getDate()+days);
  return def.toISOString().split('T')[0];
}

// â”€â”€ Extraction date livraison estimÃ©e â”€â”€
function extractDeliveryDate(text) {
  const MONTHS = {janvier:1,fÃ©vrier:2,mars:3,avril:4,mai:5,juin:6,juillet:7,aoÃ»t:8,septembre:9,octobre:10,novembre:11,dÃ©cembre:12};
  // "sera livrÃ© lundi 02 fÃ©vrier" / "livrÃ© jeudi 15 janvier"
  const m1 = text.match(/(?:livrÃ©?[e]?|disponible)\s+(?:le\s+)?(?:lundi|mardi|mercredi|jeudi|vendredi|samedi|dimanche)?\s*(\d{1,2})\s+([a-zÃ©]+)(?:\s+(\d{4}))?/i);
  if (m1) {
    const mo = MONTHS[m1[2].toLowerCase()];
    if (mo) {
      const y = m1[3] || new Date().getFullYear();
      return `${y}-${String(mo).padStart(2,'0')}-${m1[1].padStart(2,'0')}`;
    }
  }
  // "vendredi 19/12/2025 entre 11:15"
  const m2 = text.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})/);
  if (m2) return `${m2[3]}-${m2[2].padStart(2,'0')}-${m2[1].padStart(2,'0')}`;
  // "20/11/2025"
  return '';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSING EMAIL â†’ COLIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function decodeBase64(str) {
  try { return decodeURIComponent(escape(atob(str.replace(/-/g,'+').replace(/_/g,'/')))); } catch { return ''; }
}

function getEmailBody(payload) {
  if (!payload) return '';
  if (payload.body?.data) return decodeBase64(payload.body.data);
  if (payload.parts) {
    for (const p of payload.parts) {
      if (p.mimeType==='text/plain' && p.body?.data) return decodeBase64(p.body.data);
    }
    for (const p of payload.parts) { const s=getEmailBody(p); if(s) return s; }
  }
  return '';
}

function getHeader(headers, name) {
  return headers?.find(h=>h.name.toLowerCase()===name.toLowerCase())?.value||'';
}

function parseEmailToPackage(msg, slot) {
  const headers = msg.payload?.headers||[];
  const from    = getHeader(headers,'from');
  const subject = getHeader(headers,'subject');
  const dateStr = getHeader(headers,'date');
  const body    = getEmailBody(msg.payload);
  const full    = subject+'\n'+body;
  const flo=from.toLowerCase(), slo=subject.toLowerCase(), blo=body.toLowerCase();

  const det = CARRIER_DETECTORS.find(d=>d.test(flo,slo,blo));
  if (!det) return null;
  const c = det.c;

  const trackingNum   = extractTracking(c, full);
  const pickupCode    = extractPickupCode(full);
  const lockerAddress = extractAddress(c, full);
  const arrivalDate   = new Date(dateStr||Date.now()).toISOString();
  const status        = detectStatus(full);
  const expiryDate    = extractExpiry(full, arrivalDate, c);
  const deliveryDate  = extractDeliveryDate(full);

  if (!trackingNum && !lockerAddress && !pickupCode) return null;

  return {
    id:null, carrier:c,
    trackingNum, pickupCode,
    lockerAddress: lockerAddress||'',
    deliveryDate, arrivalDate, expiryDate, status,
    emailSubject: subject.substring(0,120),
    gmailLink: `https://mail.google.com/mail/u/0/#inbox/${msg.id}`,
    source: `account${slot}_gmail`,
    account: slot, gmailMsgId: msg.id, note:''
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PARSING SMS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseSMSText(smsText) {
  const lo = smsText.toLowerCase();
  const det = CARRIER_DETECTORS.find(d=>d.test('',lo,lo));
  const c = det?.c || 'other';

  const trackingNum   = extractTracking(c, smsText);
  const pickupCode    = extractPickupCode(smsText);
  const lockerAddress = extractAddress(c, smsText);
  const status        = detectStatus(smsText);
  const now           = new Date().toISOString();
  const expiryDate    = extractExpiry(smsText, now, c);
  const deliveryDate  = extractDeliveryDate(smsText);

  return {
    id: null, carrier: c,
    trackingNum, pickupCode,
    lockerAddress: lockerAddress||'',
    deliveryDate, arrivalDate: now, expiryDate, status,
    emailSubject: 'Via SMS',
    gmailLink:'', source:'sms', account:1, gmailMsgId:'', note:''
  };
}

function parseSMSManual() {
  const text = document.getElementById('smsInput').value.trim();
  if (!text) { showToast('âš ï¸ Collez un SMS d\'abord'); return; }
  const pkg = parseSMSText(text);
  pkg.id = appData.nextId++;
  appData.packages.unshift(pkg);
  saveData(appData);
  render();
  document.getElementById('smsInput').value = '';
  showToast('âœ“ Colis dÃ©tectÃ© : ' + (CARRIER_LABELS[pkg.carrier]||pkg.carrier));
  closeModal('syncModal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OAUTH â€” MODE NAVIGATEUR EXTERNE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Dans un APK Android, la WebView bloque les popups OAuth Google.
// Solution : on ouvre le navigateur systÃ¨me avec window.open (intent),
// et l'utilisateur copie le token et le colle manuellement.
const OAUTH_AUTH_URL = 'https://famhub-oauth.netlify.app/'; // page d'aide

function openOAuthBrowser(n) {
  // Ouvrir la page d'aide OAuth dans Chrome externe
  const url = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${encodeURIComponent(CLIENT_ID||'CONFIGURE_CLIENT_ID')}&redirect_uri=urn:ietf:wg:oauth:2.0:oob&response_type=token&scope=${encodeURIComponent(GMAIL_SCOPE)}&prompt=select_account`;
  // Dans l'APK Capacitor, window.open() ouvre le navigateur systÃ¨me
  const w = window.open(url, '_system');
  if (!w) {
    // Fallback : montrer l'URL Ã  copier
    showToast('Copiez l\'URL et ouvrez-la dans Chrome');
  }
  document.getElementById('tokenAccountSelect').value = String(n);
  showToast('ğŸ”— Navigateur ouvert â€” copiez le token aprÃ¨s connexion');
}

function saveManualToken() {
  const raw = document.getElementById('tokenInput').value.trim();
  const n   = parseInt(document.getElementById('tokenAccountSelect').value);
  if (!raw) { showToast('âš ï¸ Token vide'); return; }
  // Extraire access_token si l'utilisateur a collÃ© l'URL complÃ¨te
  let token = raw;
  const urlMatch = raw.match(/access_token=([^&]+)/);
  if (urlMatch) token = urlMatch[1];

  setTokenStore(n, { accessToken: token, email: appData.accounts[n].email,
    name: appData.accounts[n].name, expiry: Date.now() + 3600*1000 });
  renderAccounts();
  showToast('âœ“ Token compte ' + n + ' enregistrÃ©');
  document.getElementById('tokenInput').value = '';
  setTimeout(() => syncAccount(n), 500);
}

function toggleTokenVis() {
  const inp = document.getElementById('tokenInput');
  inp.type = inp.type==='password'?'text':'password';
}

// Token store
function getTokenStore(n) {
  try { return JSON.parse(localStorage.getItem('lt_token_'+n))||null; } catch { return null; }
}
function setTokenStore(n,d) { localStorage.setItem('lt_token_'+n,JSON.stringify(d)); }
function clearTokenStore(n) { localStorage.removeItem('lt_token_'+n); }

function disconnectAccount(n) {
  if (!confirm('DÃ©connecter ce compte ?')) return;
  clearTokenStore(n);
  renderAccounts();
  showToast('âœ“ Compte '+n+' dÃ©connectÃ©');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GMAIL API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function gmailFetch(token, path) {
  const r = await fetch('https://gmail.googleapis.com/gmail/v1/'+path, {
    headers:{ Authorization:'Bearer '+token }
  });
  if (r.status===401) throw new Error('TOKEN_EXPIRED');
  if (!r.ok) throw new Error('Gmail API '+r.status);
  return r.json();
}

async function syncAccount(n) {
  const ts = getTokenStore(n);
  if (!ts?.accessToken) { showToast('âš ï¸ Compte '+n+' non connectÃ©'); return; }
  if (Date.now() > ts.expiry-60000) {
    showToast('âš ï¸ Session expirÃ©e â€” reconnectez le compte '+n);
    clearTokenStore(n); renderAccounts(); return;
  }

  const resultEl = document.getElementById('acc'+n+'syncResult');
  const fill = document.getElementById('progress'+n);
  if (resultEl) resultEl.textContent='ğŸ” Recherche des mails transporteursâ€¦';
  if (fill) { fill.style.width='0%'; fill.style.transition='width 3s linear'; fill.style.width='80%'; }

  try {
    const query = 'subject:(colis OR locker OR "point relais" OR pickup OR disponible OR livraison OR tracking) newer_than:45d';
    const list  = await gmailFetch(ts.accessToken, `users/me/messages?maxResults=60&q=${encodeURIComponent(query)}`);
    const msgs  = list.messages||[];
    if (resultEl) resultEl.textContent=`ğŸ“¬ ${msgs.length} email(s) trouvÃ©(s)â€¦`;

    const existingIds = new Set(appData.packages.map(p=>p.gmailMsgId).filter(Boolean));
    let newCount=0, skip=0;

    for (const m of msgs) {
      if (existingIds.has(m.id)) { skip++; continue; }
      const full = await gmailFetch(ts.accessToken, `users/me/messages/${m.id}?format=full`);
      const pkg  = parseEmailToPackage(full, n);
      if (pkg) { pkg.id=appData.nextId++; appData.packages.unshift(pkg); newCount++; }
    }

    appData.accounts[n].lastSync = new Date().toISOString();
    saveData(appData); render();
    if (fill) { fill.style.transition='width 0.3s'; fill.style.width='100%'; }
    const msg = newCount>0 ? `âœ“ ${newCount} nouveau(x) colis !` : `âœ“ Aucun nouveau (${msgs.length} analysÃ©s)`;
    if (resultEl) resultEl.textContent=msg;
    showToast(msg);
  } catch(err) {
    const msg = err.message==='TOKEN_EXPIRED' ? 'âš ï¸ Token expirÃ©, reconnectez-vous' : 'âŒ '+err.message;
    if (resultEl) resultEl.textContent=msg;
    if (err.message==='TOKEN_EXPIRED') { clearTokenStore(n); renderAccounts(); }
    showToast(msg);
  } finally {
    renderAccounts();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function statusLabel(s) {
  return {ready:'Ã€ retirer',pending:'En route',delivered:'LivrÃ©',expired:'ExpirÃ©',collected:'RÃ©cupÃ©rÃ©'}[s]||s;
}
function statusClass(s) {
  return {ready:'s-ready',pending:'s-pending',delivered:'s-delivered',expired:'s-expired',collected:'s-collected'}[s]||'s-pending';
}

function daysLeft(exp) {
  if (!exp) return null;
  const diff = Math.floor((new Date(exp)-Date.now())/(1000*86400));
  return diff;
}

function expiryColor(days) {
  if (days<0) return 'var(--red)';
  if (days<=2) return 'var(--red)';
  if (days<=5) return 'var(--amber)';
  return 'var(--green)';
}

function render() {
  const pkgs = getFilteredPackages();
  updateBadges();
  const el = document.getElementById('pkgList');

  if (!pkgs.length) {
    el.innerHTML = `<div class="empty">
      <div class="empty-icon">ğŸ“­</div>
      <div class="empty-title">Aucun colis</div>
      <div class="empty-sub">Appuyez sur ï¼‹ pour en ajouter un<br>ou synchronisez vos comptes Gmail</div>
    </div>`;
    return;
  }

  el.innerHTML = pkgs.map(p => {
    const color = CARRIER_COLORS[p.carrier]||'var(--teal)';
    const days  = daysLeft(p.expiryDate);
    const pct   = p.expiryDate ? Math.max(0, Math.min(100, (days/(CARRIER_RETENTION[p.carrier]||14))*100)) : null;
    const showExpiry = p.status==='ready' && days!==null;
    const dLabel = p.deliveryDate ? fmtDate(p.deliveryDate) : '';

    return `<div class="pkg-card" id="pkg${p.id}" onclick="toggleCard(${p.id})">
      <div class="pkg-header">
        <div class="carrier-dot" style="background:${color}"></div>
        <div class="carrier-name">${CARRIER_LABELS[p.carrier]||p.carrier}${p.account?` Â· ${p.account===1?'Guillaume':'MichÃ¨le'}`:''}</div>
        <div class="status-pill ${statusClass(p.status)}">${statusLabel(p.status)}</div>
      </div>
      <div class="pkg-body" id="body${p.id}" style="display:none">
        ${p.trackingNum?`<div class="pkg-row"><div class="pkg-field">
          <div class="field-label">NÂ° Suivi</div>
          <div class="field-val mono">${p.trackingNum}</div>
        </div></div>`:''}
        ${p.pickupCode?`<div class="pkg-code-box">
          <div class="code-label">Code de retrait</div>
          <div class="code-val">${p.pickupCode}</div>
          ${p.pickupCode.includes('/')?'<div class="code-sub">Saisir les deux codes successivement</div>':''}
        </div>`:''}
        ${p.lockerAddress?`<div class="pkg-addr">ğŸ“ ${p.lockerAddress}</div>`:''}
        <div class="pkg-row">
          ${dLabel?`<div class="pkg-field"><div class="field-label">Date livraison</div><div class="field-val">${dLabel}</div></div>`:''}
          ${showExpiry?`<div class="pkg-field"><div class="field-label">Expire dans</div>
            <div class="field-val" style="color:${expiryColor(days)}">${days<0?'ExpirÃ©':days===0?'Aujourd\'hui':days+' jour'+( days>1?'s':'')}</div>
          </div>`:''}
        </div>
        ${p.note?`<div class="pkg-addr" style="margin-top:8px">ğŸ’¬ ${p.note}</div>`:''}
        ${showExpiry&&pct!==null?`<div class="expiry-bar"><div class="expiry-fill" style="width:${pct}%;background:${expiryColor(days)}"></div></div>`:''}
        <div class="pkg-actions">
          ${p.pickupCode||p.trackingNum?`<button class="act-btn primary" onclick="showQR(${p.id},event)">ğŸ“± QR</button>`:''}
          ${p.gmailLink?`<a class="act-btn" href="${p.gmailLink}" target="_blank" rel="noopener" onclick="event.stopPropagation()">ğŸ“§ Mail</a>`:''}
          ${p.status!=='collected'&&p.status!=='delivered'?`<button class="act-btn" onclick="markCollected(${p.id},event)">âœ“ RÃ©cupÃ©rÃ©</button>`:''}
          <button class="act-btn danger" onclick="deletePackage(${p.id},event)">ğŸ—‘</button>
        </div>
      </div>
    </div>`;
  }).join('');
}

function toggleCard(id) {
  const body = document.getElementById('body'+id);
  const card = document.getElementById('pkg'+id);
  if (!body) return;
  const isOpen = body.style.display!=='none';
  body.style.display = isOpen?'none':'block';
  card.classList.toggle('expanded',!isOpen);
}

function fmtDate(iso) {
  if (!iso) return '';
  try {
    return new Date(iso).toLocaleDateString('fr-FR',{day:'numeric',month:'long',year:'numeric'});
  } catch { return iso; }
}

function getFilteredPackages() {
  let pkgs = [...appData.packages];
  if (currentFilter!=='all') pkgs=pkgs.filter(p=>p.status===currentFilter);
  if (currentSearch) {
    const q=currentSearch.toLowerCase();
    pkgs=pkgs.filter(p=>
      (p.carrier||'').toLowerCase().includes(q)||
      (p.trackingNum||'').toLowerCase().includes(q)||
      (p.lockerAddress||'').toLowerCase().includes(q)||
      (p.note||'').toLowerCase().includes(q)||
      (p.emailSubject||'').toLowerCase().includes(q)
    );
  }
  return pkgs.sort((a,b)=>{
    const order={ready:0,pending:1,delivered:2,expired:3,collected:4};
    return (order[a.status]||9)-(order[b.status]||9);
  });
}

function updateBadges() {
  const p=appData.packages;
  document.getElementById('badgeAll').textContent=p.length;
  document.getElementById('badgeReady').textContent=p.filter(x=>x.status==='ready').length;
  document.getElementById('badgePending').textContent=p.filter(x=>x.status==='pending').length;
  document.getElementById('badgeDelivered').textContent=p.filter(x=>x.status==='delivered').length;
  document.getElementById('badgeExpired').textContent=p.filter(x=>x.status==='expired').length;
}

function setFilter(f,btn) {
  currentFilter=f;
  document.querySelectorAll('.ftab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  render();
}

function filterPackages(v) {
  currentSearch=v;
  render();
}

function markCollected(id,e) {
  e.stopPropagation();
  const p=appData.packages.find(x=>x.id===id);
  if (p) { p.status='collected'; saveData(appData); render(); showToast('âœ“ Colis marquÃ© rÃ©cupÃ©rÃ©'); }
}

function deletePackage(id,e) {
  e.stopPropagation();
  if (!confirm('Supprimer ce colis ?')) return;
  appData.packages=appData.packages.filter(p=>p.id!==id);
  saveData(appData); render();
}

// â”€â”€ QR Code â”€â”€
function showQR(id,e) {
  e.stopPropagation();
  const p=appData.packages.find(x=>x.id===id);
  if (!p) return;
  const val = p.pickupCode||p.trackingNum||'';
  if (!val) { showToast('Aucune donnÃ©e QR disponible'); return; }
  document.getElementById('qrTitle').textContent=`${CARRIER_LABELS[p.carrier]||p.carrier} â€” ${p.pickupCode?'Code retrait':'Suivi'}`;
  document.getElementById('qrValue').textContent=val;
  document.getElementById('qrContainer').innerHTML='';
  new QRCode(document.getElementById('qrContainer'),{
    text:val,width:200,height:200,
    colorDark:getComputedStyle(document.documentElement).getPropertyValue('--text').trim()||'#000',
    colorLight:'transparent',correctLevel:QRCode.CorrectLevel.M
  });
  openModal('qrModal');
}

// â”€â”€ Ajout manuel â”€â”€
function selectCarrier(c,el) {
  selectedCarrier=c;
  document.querySelectorAll('.carrier-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

function addPackage() {
  if (!selectedCarrier) { showToast('âš ï¸ SÃ©lectionnez un transporteur'); return; }
  const tracking = document.getElementById('addTracking').value.trim();
  const code     = document.getElementById('addCode').value.trim();
  const addr     = document.getElementById('addAddress').value.trim();
  const slot     = parseInt(document.getElementById('addAccount').value)||1;
  const expiry   = document.getElementById('addExpiry').value;
  const note     = document.getElementById('addNote').value.trim();
  if (!tracking&&!code&&!addr) { showToast('âš ï¸ Renseignez au moins un champ'); return; }

  const now = new Date().toISOString();
  const def = new Date(); def.setDate(def.getDate()+(CARRIER_RETENTION[selectedCarrier]||14));

  appData.packages.unshift({
    id:appData.nextId++, carrier:selectedCarrier,
    trackingNum:tracking.toUpperCase(), pickupCode:code.toUpperCase(),
    lockerAddress:addr, deliveryDate:'', arrivalDate:now,
    expiryDate: expiry||(def.toISOString().split('T')[0]),
    status:'ready', emailSubject:'Ajout manuel',
    gmailLink:'', source:'manual', account:slot, gmailMsgId:'', note
  });
  saveData(appData); render();
  closeModal('addModal'); showToast('âœ“ Colis ajoutÃ©');

  // Reset
  document.getElementById('addTracking').value='';
  document.getElementById('addCode').value='';
  document.getElementById('addAddress').value='';
  document.getElementById('addNote').value='';
  document.getElementById('addExpiry').value='';
  selectedCarrier=null;
  document.querySelectorAll('.carrier-btn').forEach(b=>b.classList.remove('selected'));
}

// â”€â”€ Accounts render â”€â”€
function renderAccounts() {
  [1,2].forEach(n => {
    const ts = getTokenStore(n);
    const s = document.getElementById('status'+n);
    const cb = document.getElementById('acc'+n+'connectBtn');
    const disc = document.getElementById('disc'+n);
    if (ts?.accessToken) {
      if (s) { s.textContent='â¬¤ ConnectÃ©'; s.className='gmail-status connected'; }
      if (cb) cb.textContent='ğŸ”„ Reconnecter';
      if (disc) disc.style.display='';
    } else {
      if (s) { s.textContent='â¬¤ Non connectÃ©'; s.className='gmail-status disconnected'; }
      if (cb) cb.textContent='ğŸ”— Connecter';
      if (disc) disc.style.display='none';
    }
  });
}

// â”€â”€ Modal helpers â”€â”€
function openModal(id) {
  document.getElementById(id).classList.add('open');
  document.body.style.overflow='hidden';
}
function closeModal(id) {
  document.getElementById(id).classList.remove('open');
  document.body.style.overflow='';
}
function openAddModal() { openModal('addModal'); }
function openSync() { openModal('syncModal'); renderAccounts(); }

// â”€â”€ Toast â”€â”€
let toastTimer;
function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),3000);
}

// â”€â”€ Theme â”€â”€
function toggleTheme() {
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  document.documentElement.setAttribute('data-theme', isDark?'light':'dark');
  document.getElementById('themeBtn').textContent=isDark?'â˜€ï¸':'ğŸŒ™';
  localStorage.setItem('lt_theme', isDark?'light':'dark');
}

function initTheme() {
  const saved = localStorage.getItem('lt_theme');
  const sys   = window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light';
  const theme = saved||sys;
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('themeBtn').textContent=theme==='dark'?'ğŸŒ™':'â˜€ï¸';
}

// â”€â”€ Click outside modal â”€â”€
document.querySelectorAll('.modal-overlay').forEach(o => {
  o.addEventListener('click', e => { if(e.target===o) closeModal(o.id); });
});

// â”€â”€ Init â”€â”€
initTheme();
renderAccounts();
render();
</script>
</body>
</html>
