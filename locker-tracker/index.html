<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#f4f4f0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="LockerTrack">
<title>LockerTrack</title>
<link rel="apple-touch-icon" href="../icons/locker-192.svg">
<meta name="apple-mobile-web-app-title" content="LockerTrack">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<link rel="manifest" href="./manifest.json">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  :root {
    --bg: #f4f4f0;
    --bg2: #eeeee8;
    --bg3: #e4e4dc;
    --surface: #ffffff;
    --border: rgba(0,0,0,0.08);
    --accent: #00b8a0;
    --accent2: #e84545;
    --accent3: #e0a800;
    --accent4: #7c5ce8;
    --text: #1a1a2e;
    --text2: #5a5a7a;
    --text3: #9999b8;
    --radius: 16px;
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Syne', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100dvh;
    overflow-x: hidden;
  }

  /* Subtle ambient glow */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: radial-gradient(ellipse 80% 50% at 20% 0%, rgba(0,184,160,0.08) 0%, transparent 60%), radial-gradient(ellipse 60% 40% at 80% 100%, rgba(124,92,232,0.06) 0%, transparent 60%);
    pointer-events: none;
    z-index: 0;
  }













  #app { position: relative; z-index: 1; }

  /* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
  .header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(244,244,240,0.88);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 16px 20px 12px;
  }
  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .logo-icon {
    width: 36px; height: 36px;
    background: var(--accent);
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .logo-text {
    font-size: 20px;
    font-weight: 800;
    letter-spacing: -0.5px;
    background: linear-gradient(90deg, var(--accent), var(--accent4));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header-actions {
    display: flex;
    gap: 6px;
    align-items: center;
    flex-shrink: 0;
  }
  .logo-text {
    font-size: 18px;
  }
  @media (max-width: 360px) {
    .logo-text { display: none; }
    .btn-select { font-size: 11px; padding: 5px 8px; }
  }

  /* Home button */
  .btn-home {
    width: 34px; height: 34px;
    border-radius: 9px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    font-size: 15px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    flex-shrink: 0;
  }
  .btn-home:active { transform: scale(0.93); background: var(--bg3); }
  .btn-icon {
    width: 38px; height: 38px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text);
    font-size: 18px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  .btn-icon:active { transform: scale(0.93); }
  .btn-icon.primary { background: var(--accent); color: var(--bg); border-color: var(--accent); }

  /* Stats row */
  .stats-row {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .stats-row::-webkit-scrollbar { display: none; }
  .stat-chip {
    flex-shrink: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 5px 14px;
    font-size: 12px;
    font-family: 'Space Mono', monospace;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .stat-dot {
    width: 7px; height: 7px;
    border-radius: 50%;
  }
  .dot-pending { background: var(--accent3); }
  .dot-ready { background: var(--accent); }
  .dot-expired { background: var(--accent2); }

  /* ‚ïê‚ïê‚ïê NAV TABS ‚ïê‚ïê‚ïê */
  .nav-tabs {
    display: flex;
    gap: 4px;
    padding: 12px 20px 0;
    background: var(--bg);
  }
  .nav-tab {
    flex: 1;
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 13px;
    font-weight: 600;
    text-align: center;
    cursor: pointer;
    color: var(--text2);
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .nav-tab.active {
    background: var(--surface);
    border-color: var(--border);
    color: var(--accent);
  }

  /* ‚ïê‚ïê‚ïê MAIN CONTENT ‚ïê‚ïê‚ïê */
  .content {
    padding: 16px 16px calc(80px + var(--safe-bottom));
  }

  /* Section label */
  .section-label {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text3);
    text-transform: uppercase;
    letter-spacing: 2px;
    margin: 16px 4px 8px;
  }

  /* ‚ïê‚ïê‚ïê PACKAGE CARD ‚ïê‚ïê‚ïê */
  .pkg-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 10px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.2s, box-shadow 0.2s;
    animation: slideUp 0.3s ease both;
  }
  .pkg-card:active { transform: scale(0.98); }
  .pkg-card.expanded { border-color: var(--accent); }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .pkg-card-header {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 14px;
  }

  .pkg-carrier-badge {
    width: 46px; height: 46px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px;
    flex-shrink: 0;
  }

  .pkg-main { flex: 1; min-width: 0; }
  .pkg-carrier-name {
    font-size: 13px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 3px;
  }
  .pkg-locker {
    font-size: 12px;
    color: var(--text2);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .pkg-right { text-align: right; flex-shrink: 0; }
  .pkg-status {
    font-size: 11px;
    font-weight: 700;
    padding: 3px 9px;
    border-radius: 6px;
    margin-bottom: 4px;
    display: inline-block;
  }
  .status-ready { background: rgba(0,229,200,0.15); color: var(--accent); }
  .status-pending { background: rgba(255,209,102,0.15); color: var(--accent3); }
  .status-expired { background: rgba(255,107,107,0.15); color: var(--accent2); }
  .status-collected { background: rgba(255,255,255,0.08); color: var(--text2); }

  .pkg-date {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text3);
  }

  .pkg-source-badge {
    font-size: 10px;
    background: var(--bg3);
    border-radius: 4px;
    padding: 2px 6px;
    font-family: 'Space Mono', monospace;
    color: var(--text3);
    margin-top: 2px;
  }

  /* Expanded details */
  .pkg-details {
    display: none;
    padding: 0 16px 16px;
    border-top: 1px solid var(--border);
    padding-top: 14px;
  }
  .pkg-card.expanded .pkg-details { display: block; }

  .code-block {
    background: var(--bg3);
    border: 1px solid rgba(0,229,200,0.2);
    border-radius: 10px;
    padding: 12px 16px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
  }
  .code-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    color: var(--text3);
    margin-bottom: 4px;
    font-family: 'Space Mono', monospace;
  }
  .code-value {
    font-family: 'Space Mono', monospace;
    font-size: 22px;
    font-weight: 700;
    color: var(--accent);
    letter-spacing: 4px;
  }
  .btn-copy {
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.2s;
    font-family: 'Syne', sans-serif;
  }
  .btn-copy:active { transform: scale(0.95); }
  .btn-copy.copied { background: var(--accent4); }

  /* QR code */
  .qr-container {
    background: white;
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    margin-bottom: 10px;
    gap: 10px;
  }
  .qr-container canvas,
  .qr-container img { border-radius: 4px; display: block; }
  .qr-label {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
    color: #333;
    letter-spacing: 1px;
    text-align: center;
    word-break: break-all;
  }

  .pkg-info-row {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text2);
    margin-bottom: 6px;
    font-family: 'Space Mono', monospace;
  }
  .pkg-info-row span:last-child { color: var(--text); font-weight: 600; }

  .btn-collected {
    width: 100%;
    padding: 11px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    margin-top: 6px;
    transition: all 0.2s;
    font-family: 'Syne', sans-serif;
  }
  .btn-collected:active { background: var(--bg3); }

  /* ‚ïê‚ïê‚ïê BOTTOM NAV ‚ïê‚ïê‚ïê */
  .bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0; right: 0;
    background: rgba(244,244,240,0.95);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: flex;
    padding: 8px 8px calc(8px + var(--safe-bottom));
    z-index: 200;
  }
  .nav-item {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    padding: 8px 4px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text3);
    font-size: 10px;
    font-weight: 600;
  }
  .nav-item.active { color: var(--accent); }
  .nav-item .nav-icon { font-size: 20px; line-height: 1; }
  .nav-item:active { transform: scale(0.93); }

  /* FAB */
  .fab {
    position: fixed;
    bottom: calc(72px + var(--safe-bottom));
    right: 20px;
    width: 54px; height: 54px;
    background: var(--accent);
    border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(0,184,160,0.35);
    z-index: 150;
    transition: transform 0.2s, box-shadow 0.2s;
    border: none;
    color: var(--bg);
  }
  .fab:active { transform: scale(0.93); box-shadow: 0 2px 10px rgba(0,184,160,0.25); }

  /* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(8px);
    z-index: 500;
    display: none;
    align-items: flex-end;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--bg2);
    border-radius: 24px 24px 0 0;
    border: 1px solid var(--border);
    border-bottom: none;
    width: 100%;
    max-height: 92dvh;
    overflow-y: auto;
    padding: 20px 20px calc(20px + var(--safe-bottom));
    animation: slideModal 0.3s ease;
  }
  @keyframes slideModal {
    from { transform: translateY(100%); }
    to   { transform: translateY(0); }
  }
  .modal-handle {
    width: 40px; height: 4px;
    background: var(--border);
    border-radius: 2px;
    margin: 0 auto 20px;
  }
  .modal-title {
    font-size: 20px;
    font-weight: 800;
    margin-bottom: 20px;
  }
  .form-group {
    margin-bottom: 16px;
  }
  .form-label {
    font-size: 12px;
    color: var(--text2);
    font-weight: 600;
    margin-bottom: 8px;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-family: 'Space Mono', monospace;
  }
  .form-input, .form-select {
    width: 100%;
    padding: 12px 14px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    color: var(--text);
    font-size: 15px;
    font-family: 'Syne', sans-serif;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  .form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--accent);
  }
  .carrier-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  .carrier-btn {
    padding: 12px 8px;
    background: var(--surface);
    border: 2px solid var(--border);
    border-radius: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    color: var(--text);
    font-family: 'Syne', sans-serif;
  }
  .carrier-btn.selected {
    border-color: var(--accent);
    background: rgba(0,229,200,0.08);
  }
  .carrier-emoji { font-size: 22px; display: block; margin-bottom: 4px; }
  .carrier-name-small { font-size: 11px; font-weight: 600; }

  .btn-submit {
    width: 100%;
    padding: 14px;
    background: var(--accent);
    color: var(--bg);
    border: none;
    border-radius: 12px;
    font-size: 15px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 8px;
    font-family: 'Syne', sans-serif;
    transition: all 0.2s;
  }
  .btn-submit:active { transform: scale(0.97); }

  /* ‚ïê‚ïê‚ïê ACCOUNTS PAGE ‚ïê‚ïê‚ïê */
  .account-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
    margin-bottom: 10px;
    overflow: visible;
  }
  .account-header {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .account-header > div:last-child {
    margin-left: auto;
    flex-shrink: 0;
  }
  .account-avatar {
    width: 44px; height: 44px;
    border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
  }
  .avatar-1 { background: linear-gradient(135deg, #00e5c8, #0066ff); }
  .avatar-2 { background: linear-gradient(135deg, #ff6b6b, #a78bfa); }
  .account-info h3 { font-size: 15px; font-weight: 700; }
  .account-info p { font-size: 12px; color: var(--text2); font-family: 'Space Mono', monospace; }
  .sync-btn {
    margin-left: auto;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 6px 12px;
    color: var(--text2);
    font-size: 12px;
    cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    font-family: 'Syne', sans-serif;
    transition: all 0.2s;
  }
  .sync-btn:active { border-color: var(--accent); color: var(--accent); }
  .sync-btn.syncing span { animation: spin 1s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .source-list { display: flex; gap: 8px; flex-wrap: wrap; }
  .source-tag {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 6px;
    font-family: 'Space Mono', monospace;
    display: flex; align-items: center; gap: 5px;
  }
  .source-tag.gmail { background: rgba(255,107,107,0.15); color: #ff9999; }
  .source-tag.sms { background: rgba(0,229,200,0.15); color: var(--accent); }
  .source-tag.status-ok { background: rgba(0,229,200,0.1); color: var(--accent); }

  .last-sync {
    font-size: 11px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    margin-top: 10px;
  }

  /* ‚ïê‚ïê‚ïê EMPTY STATE ‚ïê‚ïê‚ïê */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text3);
  }
  .empty-icon { font-size: 52px; margin-bottom: 16px; }
  .empty-title { font-size: 16px; font-weight: 700; color: var(--text2); margin-bottom: 8px; }
  .empty-desc { font-size: 13px; line-height: 1.6; }

  /* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
  .toast {
    position: fixed;
    top: -60px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--accent);
    color: var(--bg);
    padding: 10px 20px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    z-index: 999;
    transition: top 0.3s ease;
    white-space: nowrap;
    font-family: 'Syne', sans-serif;
  }
  .toast.show { top: 20px; }

  /* ‚ïê‚ïê‚ïê VIEWS ‚ïê‚ïê‚ïê */
  .view { display: none; }
  .view.active { display: block; }


  /* ‚ïê‚ïê‚ïê SELECTION MODE ‚ïê‚ïê‚ïê */
  .pkg-checkbox {
    width: 22px; height: 22px;
    border-radius: 7px;
    border: 2px solid var(--border);
    background: var(--surface);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.15s;
    font-size: 13px;
  }
  .pkg-card.selected .pkg-checkbox {
    background: var(--accent);
    border-color: var(--accent);
    color: white;
  }
  .pkg-card.selected {
    border-color: var(--accent);
    background: rgba(0,184,160,0.04);
  }
  .bulk-bar {
    position: fixed;
    bottom: calc(72px + var(--safe-bottom));
    left: 12px; right: 12px;
    background: var(--text);
    color: var(--bg);
    border-radius: 16px;
    padding: 12px 16px;
    display: none;
    flex-direction: column;
    gap: 10px;
    z-index: 300;
    box-shadow: 0 8px 32px rgba(0,0,0,0.25);
    animation: slideUp 0.2s ease;
  }
  .bulk-bar.open { display: flex; }
  .bulk-bar-top { display: flex; align-items: center; justify-content: space-between; }
  .bulk-count { font-size: 13px; font-weight: 700; font-family: "Space Mono", monospace; }
  .bulk-cancel {
    background: rgba(255,255,255,0.12); border: none; border-radius: 8px;
    color: var(--bg); padding: 6px 12px; font-size: 12px; cursor: pointer;
    font-family: "Syne", sans-serif;
  }
  .bulk-actions { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
  .bulk-actions::-webkit-scrollbar { display: none; }
  .bulk-action-btn {
    flex-shrink: 0; padding: 8px 14px; border-radius: 10px; border: none;
    font-size: 12px; font-weight: 700; cursor: pointer; font-family: "Syne", sans-serif;
    transition: all 0.15s; display: flex; align-items: center; gap: 6px;
  }
  .bulk-action-btn:active { transform: scale(0.95); }
  .bulk-btn-ready     { background: rgba(0,184,160,0.2);   color: var(--accent); }
  .bulk-btn-pending   { background: rgba(224,168,0,0.2);   color: var(--accent3); }
  .bulk-btn-collected { background: rgba(255,255,255,0.15); color: #fff; }
  .bulk-btn-expired   { background: rgba(232,69,69,0.2);   color: var(--accent2); }
  .bulk-btn-delete    { background: rgba(232,69,69,0.15);  color: var(--accent2); }
  .btn-select {
    background: none; border: 1px solid var(--border); border-radius: 10px;
    padding: 6px 12px; font-size: 12px; font-weight: 600; color: var(--text2);
    cursor: pointer; font-family: "Syne", sans-serif; transition: all 0.15s; white-space: nowrap;
  }
  .btn-select.active { background: var(--accent); border-color: var(--accent); color: white; }
  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to   { transform: translateY(0);    opacity: 1; }
  }

  /* Carrier colors */
  .c-chronopost { background: rgba(0,48,135,0.1); }
  .c-mondialrelay { background: rgba(226,0,26,0.1); }
  .c-vintedgo { background: rgba(0,119,130,0.1); }
  .c-laposte { background: rgba(255,190,0,0.12); }
  .c-amazon { background: rgba(255,153,0,0.12); }
  .c-colissimo { background: rgba(0,48,135,0.1); }
  .c-dpd { background: rgba(220,0,50,0.1); }
  .c-ups { background: rgba(53,28,21,0.1); }
  .c-other { background: rgba(0,0,0,0.05); }

  /* Carrier logo in modal */
  .carrier-logo-img {
    width: 28px;
    height: 28px;
    object-fit: contain;
    border-radius: 6px;
  }
  .carrier-emoji {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 36px;
  }

  /* Progress bar sync */
  .sync-progress {
    height: 2px;
    background: var(--bg3);
    border-radius: 1px;
    margin-top: 10px;
    overflow: hidden;
  }
  .sync-progress-bar {
    height: 100%;
    background: var(--accent);
    border-radius: 1px;
    width: 0;
    transition: width 0.5s ease;
  }

  .divider {
    height: 1px;
    background: var(--border);
    margin: 6px 0;
  }

  /* Urgency indicator */
  .urgency-bar {
    height: 3px;
    border-radius: 0 0 0 0;
  }
  .urgency-high { background: linear-gradient(90deg, var(--accent2), transparent); }
  .urgency-med { background: linear-gradient(90deg, var(--accent3), transparent); }
  .urgency-low { background: linear-gradient(90deg, var(--accent), transparent); }
  .urgency-none { display: none; }

  /* QR toggle */
  .btn-qr {
    width: 100%;
    padding: 11px;
    border-radius: 10px;
    border: 1px solid rgba(0,229,200,0.3);
    background: rgba(0,229,200,0.06);
    color: var(--accent);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    margin-bottom: 10px;
    font-family: 'Syne', sans-serif;
    transition: all 0.2s;
  }
  .btn-qr:active { background: rgba(0,229,200,0.12); }

  /* Search */
  .search-bar {
    display: flex;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 10px 14px;
    gap: 10px;
    margin-bottom: 4px;
    transition: border-color 0.2s;
  }
  .search-bar:focus-within { border-color: var(--accent); }
  .search-icon { font-size: 16px; color: var(--text3); }
  .search-input {
    flex: 1;
    background: none;
    border: none;
    color: var(--text);
    font-size: 14px;
    font-family: 'Syne', sans-serif;
  }
  .search-input:focus { outline: none; }
  .search-input::placeholder { color: var(--text3); }

  /* Filter chips */
  .filter-row {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    padding: 10px 0 4px;
  }
  .filter-row::-webkit-scrollbar { display: none; }
  .filter-chip {
    flex-shrink: 0;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    transition: all 0.2s;
  }
  .filter-chip.active {
    border-color: var(--accent);
    background: rgba(0,229,200,0.1);
    color: var(--accent);
  }

  /* Notification banner */
  .notif-banner {
    background: linear-gradient(135deg, rgba(0,229,200,0.1), rgba(167,139,250,0.1));
    border: 1px solid rgba(0,229,200,0.2);
    border-radius: 12px;
    padding: 12px 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 12px;
    cursor: pointer;
  }
  .notif-icon { font-size: 22px; }
  .notif-text { flex: 1; font-size: 13px; line-height: 1.4; }
  .notif-text strong { color: var(--accent); }
  .notif-close { color: var(--text3); font-size: 16px; cursor: pointer; padding: 4px; }

  /* Days left */
  .days-left {
    font-size: 11px;
    font-family: 'Space Mono', monospace;
  }
  .days-urgent { color: var(--accent2); }
  .days-warn { color: var(--accent3); }
  .days-ok { color: var(--accent); }
</style>
</head>
<body>

<div id="app">

  <!-- TOAST -->
  <div class="toast" id="toast"></div>

  <!-- HEADER -->
  <header class="header">
    <div class="header-top">
      <div class="logo">
        <div class="logo-icon">üì¶</div>
        <span class="logo-text">LockerTrack</span>
      </div>
      <div class="header-actions">
        <a class="btn-home" id="homeBtn" href="../index.html" title="Accueil" style="display:none">‚åÇ</a>
        <button class="btn-icon" onclick="openSearch()" title="Rechercher">üîç</button>
        <button class="btn-select" id="selectModeBtn" onclick="toggleSelectMode()">S√©lectionner</button>
        <button class="btn-icon primary" onclick="syncAll()" title="Synchroniser" id="syncBtn">‚ü≥</button>
      </div>
    </div>
    <div class="stats-row" id="statsRow">
      <!-- filled by JS -->
    </div>
  </header>

  <!-- VIEWS -->
  <main>

    <!-- ‚îÄ‚îÄ VIEW : PACKAGES ‚îÄ‚îÄ -->
    <div class="view active" id="view-packages">
      <div style="padding: 12px 16px 0;">
        <div class="search-bar" id="searchBar" style="display:none">
          <span class="search-icon">üîç</span>
          <input class="search-input" placeholder="Rechercher un colis, transporteur‚Ä¶" oninput="filterPackages(this.value)" id="searchInput">
          <span style="cursor:pointer;color:var(--text3)" onclick="closeSearch()">‚úï</span>
        </div>
        <div class="filter-row">
          <div class="filter-chip" onclick="setFilter('all', this)">Tous</div>
          <div class="filter-chip active" onclick="setFilter('ready', this)">Pr√™ts</div>
          <div class="filter-chip" onclick="setFilter('pending', this)">En route</div>
          <div class="filter-chip" onclick="setFilter('expired', this)">Expir√©s</div>
          <div class="filter-chip" onclick="setFilter('collected', this)">R√©cup√©r√©s</div>
        </div>
      </div>
      <div class="content" id="packageList">
        <!-- filled by JS -->
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VIEW : PAR ADRESSE ‚îÄ‚îÄ -->
    <div class="view" id="view-locations">
      <div class="loc-sort-row">
        <div class="loc-sort-chip active" onclick="setLocSort('count', this)">üî¢ Nb colis</div>
        <div class="loc-sort-chip" onclick="setLocSort('urgency', this)">‚ö° Urgence</div>
        <div class="loc-sort-chip" onclick="setLocSort('alpha', this)">üî§ A ‚Üí Z</div>
      </div>
      <div class="content" id="locationList">
        <!-- filled by JS -->
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VIEW : COMPTES ‚îÄ‚îÄ -->
    <div class="view" id="view-accounts">
      <div class="content">

        <!-- Setup banner (shown when no account connected) -->
        <div id="setupBanner" style="display:none;background:linear-gradient(135deg,rgba(0,184,160,0.08),rgba(124,92,232,0.08));border:1px solid rgba(0,184,160,0.2);border-radius:14px;padding:16px;margin-bottom:16px;">
          <div style="font-size:15px;font-weight:700;margin-bottom:6px;">üöÄ Premi√®re connexion</div>
          <p style="font-size:12px;color:var(--text2);line-height:1.6;">Connectez vos comptes Gmail pour que LockerTrack d√©tecte automatiquement vos colis dans vos emails.</p>
        </div>

        <!-- Client ID config -->
        <div id="clientIdBanner" style="background:rgba(224,168,0,0.08);border:1px solid rgba(224,168,0,0.25);border-radius:12px;padding:14px;margin-bottom:14px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div style="flex:1">
              <div style="font-size:12px;font-weight:700;color:var(--accent3);margin-bottom:4px;">üîë Client ID Google OAuth</div>
              <div style="font-size:11px;color:var(--text2);line-height:1.5;">Requis pour la connexion Gmail. Obtenez-le sur <a href="https://console.cloud.google.com" target="_blank" style="color:var(--accent)">Google Cloud Console</a>.</div>
            </div>
            <button onclick="toggleClientIdEdit()" style="background:none;border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:11px;color:var(--text2);cursor:pointer;white-space:nowrap;font-family:'Syne',sans-serif;">‚öôÔ∏è Configurer</button>
          </div>
          <div id="clientIdEdit" style="display:none;margin-top:12px;">
            <input class="form-input" id="clientIdInput" placeholder="123456789-abc.apps.googleusercontent.com" style="font-size:12px;font-family:'Space Mono',monospace;">
            <div style="display:flex;gap:8px;margin-top:8px;">
              <button onclick="saveClientId()" class="btn-submit" style="flex:1;padding:10px;font-size:13px;">‚úì Enregistrer</button>
              <button onclick="toggleClientIdEdit()" style="padding:10px 14px;background:none;border:1px solid var(--border);border-radius:10px;color:var(--text2);cursor:pointer;font-family:'Syne',sans-serif;">Annuler</button>
            </div>
          </div>
          <div id="clientIdStatus" style="margin-top:8px;font-size:11px;font-family:'Space Mono',monospace;color:var(--text3);">Non configur√©</div>
        </div>

        <div class="section-label">Comptes Gmail</div>

        <!-- Account 1 -->
        <div class="account-card" id="account1Card">
          <div class="account-header">
            <div class="account-avatar avatar-1" id="acc1avatar">üë§</div>
            <div class="account-info">
              <h3 id="acc1name">Compte principal</h3>
              <p id="acc1email">Non connect√©</p>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              <button class="sync-btn" onclick="syncAccount(1)" id="syncBtn1" style="display:none">
                <span>‚ü≥</span> Sync
              </button>
              <button id="acc1connectBtn" onclick="connectGmail(1)" class="btn-submit" style="padding:7px 14px;font-size:12px;width:auto;">
                Connecter
              </button>
              <button id="acc1disconnectBtn" onclick="disconnectAccount(1)" style="display:none;padding:7px 10px;background:none;border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--accent2);cursor:pointer;font-family:'Syne',sans-serif;">
                ‚úï
              </button>
            </div>
          </div>
          <div class="source-list" id="acc1sources">
            <span class="source-tag" style="background:rgba(0,0,0,0.05);color:var(--text3)">üìß Gmail non connect√©</span>
          </div>
          <div class="sync-progress"><div class="sync-progress-bar" id="progress1"></div></div>
          <div id="acc1syncResult" style="display:none;margin-top:10px;padding:10px;background:rgba(0,184,160,0.06);border-radius:8px;font-size:12px;color:var(--text2);"></div>
          <div class="last-sync" id="lastSync1">Jamais synchronis√©</div>
        </div>

        <!-- Account 2 -->
        <div class="account-card" id="account2Card">
          <div class="account-header">
            <div class="account-avatar avatar-2" id="acc2avatar">üë§</div>
            <div class="account-info">
              <h3 id="acc2name">Compte secondaire</h3>
              <p id="acc2email">Non connect√©</p>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              <button class="sync-btn" onclick="syncAccount(2)" id="syncBtn2" style="display:none">
                <span>‚ü≥</span> Sync
              </button>
              <button id="acc2connectBtn" onclick="connectGmail(2)" class="btn-submit" style="padding:7px 14px;font-size:12px;width:auto;">
                Connecter
              </button>
              <button id="acc2disconnectBtn" onclick="disconnectAccount(2)" style="display:none;padding:7px 10px;background:none;border:1px solid var(--border);border-radius:8px;font-size:12px;color:var(--accent2);cursor:pointer;font-family:'Syne',sans-serif;">
                ‚úï
              </button>
            </div>
          </div>
          <div class="source-list" id="acc2sources">
            <span class="source-tag" style="background:rgba(0,0,0,0.05);color:var(--text3)">üìß Gmail non connect√©</span>
          </div>
          <div class="sync-progress"><div class="sync-progress-bar" id="progress2"></div></div>
          <div id="acc2syncResult" style="display:none;margin-top:10px;padding:10px;background:rgba(0,184,160,0.06);border-radius:8px;font-size:12px;color:var(--text2);"></div>
          <div class="last-sync" id="lastSync2">Jamais synchronis√©</div>
        </div>

        <!-- How it works -->
        <div class="section-label" style="margin-top:8px;">Comment √ßa marche</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;">
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="width:28px;height:28px;background:rgba(0,184,160,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">1</div>
              <div style="font-size:12px;color:var(--text2);line-height:1.5;padding-top:4px;">Cr√©ez un projet sur <a href="https://console.cloud.google.com" target="_blank" style="color:var(--accent);font-weight:600;">Google Cloud Console</a> et activez l'API Gmail</div>
            </div>
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="width:28px;height:28px;background:rgba(0,184,160,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">2</div>
              <div style="font-size:12px;color:var(--text2);line-height:1.5;padding-top:4px;">Cr√©ez des identifiants OAuth 2.0 (application web) et copiez votre Client ID</div>
            </div>
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="width:28px;height:28px;background:rgba(0,184,160,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">3</div>
              <div style="font-size:12px;color:var(--text2);line-height:1.5;padding-top:4px;">Collez votre Client ID ci-dessus, puis connectez vos comptes Gmail</div>
            </div>
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="width:28px;height:28px;background:rgba(0,184,160,0.1);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">4</div>
              <div style="font-size:12px;color:var(--text2);line-height:1.5;padding-top:4px;">LockerTrack scanne vos mails et d√©tecte automatiquement les colis Chronopost, Mondial Relay, Vinted Go, La Poste, Amazon, Colissimo‚Ä¶</div>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ SMS Section ‚îÄ‚îÄ -->
        <div class="section-label" style="margin-top:16px;">SMS transporteurs</div>

        <div class="account-card" id="smsCard">
          <div class="account-header">
            <div class="account-avatar" style="background:linear-gradient(135deg,#e0a800,#ff6b35);font-size:22px;">üí¨</div>
            <div class="account-info">
              <h3 id="smsTitle">SMS Android</h3>
              <p id="smsStatus">V√©rification‚Ä¶</p>
            </div>
            <div style="display:flex;gap:6px;align-items:center;">
              <button class="sync-btn" id="smsSyncBtn" onclick="syncSMS()" style="display:none">
                <span>‚ü≥</span> Sync
              </button>
            </div>
          </div>

          <!-- Bridge disponible : bouton sync -->
          <div id="smsBridgeUI" style="display:none">
            <div style="font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.5;">
              LockerTrack peut lire vos SMS transporteurs pour d√©tecter automatiquement les colis, codes et statuts.
            </div>
            <button class="btn-submit" style="margin-top:0;" onclick="requestSMSPermissionAndSync()">
              üì± Autoriser et synchroniser les SMS
            </button>
            <div id="smsSyncResult" style="display:none;margin-top:10px;padding:10px;background:rgba(0,184,160,0.06);border-radius:8px;font-size:12px;color:var(--text2);"></div>
            <div class="last-sync" id="lastSyncSMS">Jamais synchronis√©</div>
          </div>

          <!-- Fallback : saisie manuelle -->
          <div id="smsManualUI" style="display:none">
            <div style="font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.5;">
              Collez ici un SMS re√ßu d'un transporteur pour en extraire automatiquement les informations.
            </div>
            <textarea id="smsManualInput"
              style="width:100%;min-height:90px;background:var(--bg3);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:12px;font-family:'Space Mono',monospace;color:var(--text);resize:vertical;outline:none;"
              placeholder="Collez votre SMS ici‚Ä¶&#10;Ex: Chronopost : votre colis PP123456789FR est disponible au relais..."></textarea>
            <button class="btn-submit" style="margin-top:8px;" onclick="parseSMSManual()">
              üîç Analyser ce SMS
            </button>
            <div id="smsManualResult" style="display:none;margin-top:10px;padding:10px;background:rgba(0,184,160,0.06);border-radius:8px;font-size:12px;color:var(--text2);"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ VIEW : PARAM√àTRES ‚îÄ‚îÄ -->
    <div class="view" id="view-settings">
      <div class="content">
        <div class="section-label">Notifications</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
            <div>
              <div style="font-size:14px;font-weight:600;">Alertes d'expiration</div>
              <div style="font-size:12px;color:var(--text2);">Rappel avant expiration du code</div>
            </div>
            <label class="toggle">
              <input type="checkbox" checked id="notifExpiry" onchange="saveSetting('notifExpiry', this.checked)">
              <span class="slider"></span>
            </label>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-size:14px;font-weight:600;">Colis disponible</div>
              <div style="font-size:12px;color:var(--text2);">Notif d√®s r√©ception confirm√©e</div>
            </div>
            <label class="toggle">
              <input type="checkbox" checked id="notifReady" onchange="saveSetting('notifReady', this.checked)">
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="section-label">Synchronisation auto</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;">
          <label class="form-label">Fr√©quence</label>
          <select class="form-select" id="syncFreq" onchange="saveSetting('syncFreq', this.value)">
            <option value="15">Toutes les 15 minutes</option>
            <option value="30" selected>Toutes les 30 minutes</option>
            <option value="60">Toutes les heures</option>
            <option value="manual">Manuel uniquement</option>
          </select>
        </div>

        <div class="section-label">Donn√©es</div>
        <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:10px;">
          <div style="padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="exportData()">
            <span style="font-size:14px;">üì§ Exporter les donn√©es</span>
            <span style="color:var(--text3)">‚Ä∫</span>
          </div>
          <div style="padding:14px 16px;border-bottom:1px solid var(--border);cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="clearCollected()">
            <span style="font-size:14px;">üóë Supprimer les r√©cup√©r√©s</span>
            <span style="color:var(--text3)">‚Ä∫</span>
          </div>
          <div style="padding:14px 16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="confirmReset()">
            <span style="font-size:14px;color:var(--accent2);">‚ö†Ô∏è R√©initialiser tout</span>
            <span style="color:var(--text3)">‚Ä∫</span>
          </div>
        </div>

        <div style="text-align:center;padding:20px;color:var(--text3);font-size:11px;font-family:'Space Mono',monospace;">
          LockerTrack v1.0.0 ¬∑ PWA<br>
          Donn√©es stock√©es localement
        </div>
      </div>
    </div>

  </main>

  <!-- FAB -->
  <button class="fab" onclick="openAddModal()" title="Ajouter un colis">Ôºã</button>

  <!-- BULK ACTION BAR -->
  <div class="bulk-bar" id="bulkBar">
    <div class="bulk-bar-top">
      <span class="bulk-count" id="bulkCount">0 s√©lectionn√©(s)</span>
      <button class="bulk-cancel" onclick="cancelSelectMode()">‚úï Annuler</button>
    </div>
    <div class="bulk-actions">
      <button class="bulk-action-btn bulk-btn-ready"     onclick="bulkSetStatus('ready')">‚úÖ Disponible</button>
      <button class="bulk-action-btn bulk-btn-pending"   onclick="bulkSetStatus('pending')">üöö En route</button>
      <button class="bulk-action-btn bulk-btn-collected" onclick="bulkSetStatus('collected')">üì¶ R√©cup√©r√©</button>
      <button class="bulk-action-btn bulk-btn-expired"   onclick="bulkSetStatus('expired')">‚è∞ Expir√©</button>
      <button class="bulk-action-btn bulk-btn-delete"    onclick="bulkDelete()">üóë Supprimer</button>
    </div>
  </div>

  <!-- BOTTOM NAV -->
  <nav class="bottom-nav">
    <div class="nav-item active" onclick="showView('packages', this)">
      <span class="nav-icon">üì¶</span>
      <span>Colis</span>
    </div>
    <div class="nav-item" onclick="showView('locations', this)">
      <span class="nav-icon">üìç</span>
      <span>Adresses</span>
    </div>
    <div class="nav-item" onclick="showView('accounts', this)">
      <span class="nav-icon">üîó</span>
      <span>Comptes</span>
    </div>
    <div class="nav-item" onclick="showView('settings', this)">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span>R√©glages</span>
    </div>
  </nav>

</div>

<!-- ADD MODAL -->
<div class="modal-overlay" id="addModal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Ajouter un colis</div>

    <div class="form-group">
      <label class="form-label">Transporteur</label>
      <div class="carrier-grid">
        <div class="carrier-btn" onclick="selectCarrier('chronopost', this)">
          <span class="carrier-emoji"><img src="https://www.chronopost.fr/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üîµ'"></span>
          <span class="carrier-name-small">Chronopost</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('mondialrelay', this)">
          <span class="carrier-emoji"><img src="https://www.mondialrelay.fr/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üî¥'"></span>
          <span class="carrier-name-small">Mondial Relay</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('vintedgo', this)">
          <span class="carrier-emoji"><img src="https://www.vinted.fr/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üü¢'"></span>
          <span class="carrier-name-small">Vinted Go</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('laposte', this)">
          <span class="carrier-emoji"><img src="https://www.laposte.fr/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üü°'"></span>
          <span class="carrier-name-small">La Poste</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('amazon', this)">
          <span class="carrier-emoji"><img src="https://www.amazon.fr/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üü†'"></span>
          <span class="carrier-name-small">Amazon</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('colissimo', this)">
          <span class="carrier-emoji"><img src="https://www.colissimo.fr/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üü£'"></span>
          <span class="carrier-name-small">Colissimo</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('dpd', this)">
          <span class="carrier-emoji"><img src="https://www.dpd.com/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üî∂'"></span>
          <span class="carrier-name-small">DPD</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('ups', this)">
          <span class="carrier-emoji"><img src="https://www.ups.com/favicon.ico" class="carrier-logo-img" onerror="this.outerHTML='üü§'"></span>
          <span class="carrier-name-small">UPS</span>
        </div>
        <div class="carrier-btn" onclick="selectCarrier('other', this)">
          <span class="carrier-emoji" style="font-size:24px">üì¶</span>
          <span class="carrier-name-small">Autre</span>
        </div>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Adresse du locker</label>
      <input class="form-input" id="lockerAddress" placeholder="Ex: Avenue de la R√©publique, Paris">
    </div>

    <div class="form-group">
      <label class="form-label">Code de r√©cup√©ration</label>
      <input class="form-input" id="pickupCode" placeholder="Ex: 4782 ou CODE123">
    </div>

    <div class="form-group">
      <label class="form-label">N¬∞ de suivi (optionnel)</label>
      <input class="form-input" id="trackingNum" placeholder="Ex: CP1234567890FR">
    </div>

    <div class="form-group">
      <label class="form-label">Date d'arriv√©e</label>
      <input class="form-input" type="datetime-local" id="arrivalDate">
    </div>

    <div class="form-group">
      <label class="form-label">Date limite de retrait</label>
      <input class="form-input" type="date" id="expiryDate">
    </div>

    <div class="form-group">
      <label class="form-label">Source</label>
      <select class="form-select" id="sourceAccount">
        <option value="account1_gmail">Compte 1 ‚Äî Gmail</option>
        <option value="account1_sms">Compte 1 ‚Äî SMS</option>
        <option value="account2_gmail">Compte 2 ‚Äî Gmail</option>
        <option value="account2_sms">Compte 2 ‚Äî SMS</option>
        <option value="manual">Saisie manuelle</option>
      </select>
    </div>

    <button class="btn-submit" onclick="addPackage()">‚úì Ajouter le colis</button>
    <button style="width:100%;padding:12px;background:none;border:none;color:var(--text2);font-size:13px;cursor:pointer;margin-top:8px;font-family:'Syne',sans-serif;" onclick="closeModal()">Annuler</button>
  </div>
</div>

<!-- Toggle CSS -->
<style>
.toggle { position: relative; display: inline-block; width: 46px; height: 26px; }
.toggle input { opacity: 0; width: 0; height: 0; }
.slider {
  position: absolute; inset: 0;
  background: #d0d0d8;
  border-radius: 13px;
  cursor: pointer;
  transition: 0.3s;
  border: 1px solid var(--border);
}
.slider:before {
  content: '';
  position: absolute;
  width: 20px; height: 20px;
  left: 2px; top: 2px;
  background: white;
  border-radius: 50%;
  transition: 0.3s;
}
input:checked + .slider { background: var(--accent); border-color: var(--accent); }
input:checked + .slider:before { transform: translateX(20px); }
</style>

<style>
  /* ‚ïê‚ïê‚ïê LOCATION VIEW ‚ïê‚ïê‚ïê */
  .location-group {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    margin-bottom: 12px;
    overflow: hidden;
    animation: slideUp 0.3s ease both;
  }
  .location-group-header {
    padding: 14px 16px;
    display: flex;
    align-items: center;
    gap: 14px;
    cursor: pointer;
    user-select: none;
  }
  .location-group-header:active { background: var(--bg); }
  .location-pin {
    width: 42px; height: 42px;
    border-radius: 12px;
    background: linear-gradient(135deg, var(--accent), var(--accent4));
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
    position: relative;
  }
  .location-count-badge {
    position: absolute;
    top: -5px; right: -5px;
    background: var(--accent2);
    color: white;
    font-size: 10px;
    font-weight: 800;
    width: 18px; height: 18px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace;
    border: 2px solid var(--surface);
  }
  .location-info { flex: 1; min-width: 0; }
  .location-name {
    font-size: 14px;
    font-weight: 700;
    margin-bottom: 3px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .location-meta {
    font-size: 11px;
    color: var(--text2);
    font-family: 'Space Mono', monospace;
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .location-chevron {
    color: var(--text3);
    font-size: 14px;
    transition: transform 0.25s;
    flex-shrink: 0;
  }
  .location-group.open .location-chevron { transform: rotate(90deg); }

  .location-pkg-list { display: none; border-top: 1px solid var(--border); }
  .location-group.open .location-pkg-list { display: block; }
  .location-actions { display: none; }
  .location-group.open .location-actions { display: flex; }

  .location-pkg-item {
    padding: 12px 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.15s;
  }
  .location-pkg-item:last-child { border-bottom: none; }
  .location-pkg-item:active { background: var(--bg); }

  .loc-carrier-dot {
    width: 32px; height: 32px;
    border-radius: 9px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .loc-pkg-info { flex: 1; min-width: 0; }
  .loc-pkg-carrier {
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 2px;
  }
  .loc-pkg-code {
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    color: var(--accent);
    font-weight: 700;
  }
  .loc-pkg-date {
    font-size: 10px;
    color: var(--text3);
    font-family: 'Space Mono', monospace;
    margin-top: 1px;
  }
  .loc-pkg-status {
    font-size: 10px;
    font-weight: 700;
    padding: 3px 8px;
    border-radius: 6px;
    flex-shrink: 0;
  }

  .location-actions {
    padding: 10px 16px 14px;
    display: flex;
    gap: 8px;
    border-top: 1px solid var(--border);
  }
  .btn-map {
    flex: 1;
    padding: 9px 14px;
    border-radius: 10px;
    border: 1px solid rgba(0,184,160,0.3);
    background: rgba(0,184,160,0.06);
    color: var(--accent);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.2s;
    text-decoration: none;
  }
  .btn-map:active { background: rgba(0,184,160,0.14); }
  .btn-copy-all {
    padding: 9px 14px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text2);
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: 'Syne', sans-serif;
    white-space: nowrap;
    transition: all 0.2s;
  }
  .btn-copy-all:active { border-color: var(--accent4); color: var(--accent4); }

  .loc-sort-row {
    display: flex;
    gap: 6px;
    padding: 12px 16px 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .loc-sort-row::-webkit-scrollbar { display: none; }
  .loc-sort-chip {
    flex-shrink: 0;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text2);
    transition: all 0.2s;
  }
  .loc-sort-chip.active {
    border-color: var(--accent4);
    background: rgba(124,92,232,0.1);
    color: var(--accent4);
  }

  .loc-status-strip { display: flex; gap: 5px; margin-top: 5px; flex-wrap: wrap; }
  .loc-strip-chip {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 5px;
    font-family: 'Space Mono', monospace;
    font-weight: 700;
  }
  .lsc-ready  { background: rgba(0,184,160,0.12); color: var(--accent); }
  .lsc-pending{ background: rgba(224,168,0,0.12); color: var(--accent3); }
  .lsc-expired{ background: rgba(232,69,69,0.12); color: var(--accent2); }
  .lsc-collected{ background: rgba(0,0,0,0.06); color: var(--text3); }

  /* Location urgency left border */
  .location-group.has-expired { border-left: 3px solid var(--accent2); }
  .location-group.has-ready   { border-left: 3px solid var(--accent); }
</style>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA STORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const STORAGE_KEY = 'lockertrack_v2';

function loadData() {
  try {
    const d = localStorage.getItem(STORAGE_KEY);
    if (d) return JSON.parse(d);
    // First launch ‚Äî start empty, no sample data
    const empty = {
      packages: [],
      accounts: {
        1: { name: 'Compte principal', email: '', phone: '', lastSync: null },
        2: { name: 'Compte secondaire', email: '', phone: '', lastSync: null }
      },
      settings: { notifExpiry: true, notifReady: true, syncFreq: '30' },
      nextId: 1
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(empty));
    return empty;
  } catch { 
    return {
      packages: [],
      accounts: {
        1: { name: 'Compte principal', email: '', phone: '', lastSync: null },
        2: { name: 'Compte secondaire', email: '', phone: '', lastSync: null }
      },
      settings: { notifExpiry: true, notifReady: true, syncFreq: '30' },
      nextId: 1
    };
  }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function getDefaultData() {
  return {
    packages: getSamplePackages(),
    accounts: {
      1: { name: 'Compte principal', email: 'alice@gmail.com', phone: '+33 6 12 34 56 78', lastSync: null },
      2: { name: 'Compte secondaire', email: 'bob@gmail.com', phone: '+33 7 98 76 54 32', lastSync: null }
    },
    settings: { notifExpiry: true, notifReady: true, syncFreq: '30' },
    nextId: 10
  };
}

function getSamplePackages() {
  return [];
}

let appData = loadData();
let currentFilter = 'ready';
let currentSearch = '';
let selectedCarrier = null;
let expandedCards = new Set();
let locSort = 'count'; // 'count' | 'urgency' | 'alpha'

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CARRIER CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Logos transporteurs via leurs favicons officiels
const CARRIER_LOGOS = {
  chronopost:   { bg: '#003087', img: 'https://www.chronopost.fr/favicon.ico' },
  mondialrelay: { bg: '#e2001a', img: 'https://www.mondialrelay.fr/favicon.ico' },
  colissimo:    { bg: '#003087', img: 'https://www.colissimo.fr/favicon.ico' },
  laposte:      { bg: '#FFBE00', img: 'https://www.laposte.fr/favicon.ico' },
  vintedgo:     { bg: '#007782', img: 'https://www.vinted.fr/favicon.ico' },
  amazon:       { bg: '#FF9900', img: 'https://www.amazon.fr/favicon.ico' },
  dpd:          { bg: '#DC0032', img: 'https://www.dpd.com/favicon.ico' },
  ups:          { bg: '#351C15', img: 'https://www.ups.com/favicon.ico' },
  other:        { bg: '#9999b8', img: null },
};

const CARRIERS = {
  chronopost:   { name: 'Chronopost',    emoji: 'üîµ', color: 'c-chronopost' },
  mondialrelay: { name: 'Mondial Relay', emoji: 'üî¥', color: 'c-mondialrelay' },
  vintedgo:     { name: 'Vinted Go',     emoji: 'üü¢', color: 'c-vintedgo' },
  laposte:      { name: 'La Poste',      emoji: 'üü°', color: 'c-laposte' },
  amazon:       { name: 'Amazon',        emoji: 'üü†', color: 'c-amazon' },
  colissimo:    { name: 'Colissimo',     emoji: 'üü£', color: 'c-colissimo' },
  dpd:          { name: 'DPD',           emoji: 'üî∂', color: 'c-dpd' },
  ups:          { name: 'UPS',           emoji: 'üü§', color: 'c-ups' },
  other:        { name: 'Autre',         emoji: 'üì¶', color: 'c-other' }
};

function carrierLogoHTML(carrier, size) {
  size = size || 36;
  const cfg = CARRIER_LOGOS[carrier] || CARRIER_LOGOS.other;
  const fallbackEmoji = (CARRIERS[carrier] && CARRIERS[carrier].emoji) || 'üì¶';
  const r = Math.round(size * 0.28);
  const imgSize = Math.round(size * 0.72);
  if (cfg.img) {
    // Use data attribute to avoid quote conflicts in onerror
    return '<div style="width:' + size + 'px;height:' + size + 'px;border-radius:' + r + 'px;background:' + cfg.bg + ';display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;">'
      + '<img src="' + cfg.img + '" width="' + imgSize + '" height="' + imgSize + '" style="object-fit:contain;" onerror="this.outerHTML=\'' + fallbackEmoji + '\'">'
      + '</div>';
  }
  return '<div style="width:' + size + 'px;height:' + size + 'px;border-radius:' + r + 'px;background:' + cfg.bg + ';display:flex;align-items:center;justify-content:center;font-size:' + Math.round(size * 0.5) + 'px;flex-shrink:0;">' + fallbackEmoji + '</div>';
}

const STATUS_LABELS = {
  ready: { label: 'Disponible', cls: 'status-ready' },
  pending: { label: 'En route', cls: 'status-pending' },
  expired: { label: 'Expir√©', cls: 'status-expired' },
  collected: { label: 'R√©cup√©r√©', cls: 'status-collected' }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function render() {
  renderStats();
  renderPackages();
  renderAccounts();
  renderLocations();
}

function renderStats() {
  const pkgs = appData.packages;
  const counts = {
    ready: pkgs.filter(p => p.status === 'ready').length,
    pending: pkgs.filter(p => p.status === 'pending').length,
    expired: pkgs.filter(p => p.status === 'expired').length
  };
  document.getElementById('statsRow').innerHTML = `
    <div class="stat-chip"><span class="stat-dot dot-ready"></span>${counts.ready} pr√™ts</div>
    <div class="stat-chip"><span class="stat-dot dot-pending"></span>${counts.pending} en route</div>
    ${counts.expired > 0 ? `<div class="stat-chip"><span class="stat-dot dot-expired"></span>${counts.expired} expir√©s</div>` : ''}
    <div class="stat-chip">üì± ${Object.values(appData.accounts).filter(a => a.lastSync).length}/2 syncs</div>
  `;
}

function renderPackages() {
  let pkgs = [...appData.packages];

  // Filter
  if (currentFilter !== 'all') pkgs = pkgs.filter(p => p.status === currentFilter);

  // Search
  if (currentSearch) {
    const q = currentSearch.toLowerCase();
    pkgs = pkgs.filter(p =>
      p.carrier.includes(q) || CARRIERS[p.carrier]?.name.toLowerCase().includes(q) ||
      p.lockerAddress.toLowerCase().includes(q) ||
      p.pickupCode.toLowerCase().includes(q) ||
      p.trackingNum.toLowerCase().includes(q)
    );
  }

  // Sort: ready & expired by urgency, then date
  pkgs.sort((a, b) => {
    const order = { ready: 0, expired: 1, pending: 2, collected: 3 };
    if (order[a.status] !== order[b.status]) return order[a.status] - order[b.status];
    if (a.status === 'ready' && a.expiryDate && b.expiryDate) {
      return new Date(a.expiryDate) - new Date(b.expiryDate);
    }
    return new Date(b.arrivalDate) - new Date(a.arrivalDate);
  });

  const list = document.getElementById('packageList');

  if (pkgs.length === 0) {
    list.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <div class="empty-title">Aucun colis trouv√©</div>
        <div class="empty-desc">Ajoutez un colis manuellement ou synchronisez vos comptes.</div>
      </div>`;
    return;
  }

  // Group by date
  const groups = {};
  pkgs.forEach(p => {
    const date = formatDateGroup(p.arrivalDate);
    if (!groups[date]) groups[date] = [];
    groups[date].push(p);
  });

  let html = '';
  const today = formatDateGroup(new Date().toISOString());
  const yesterday = formatDateGroup(new Date(Date.now() - 86400000).toISOString());
  const tomorrow = formatDateGroup(new Date(Date.now() + 86400000).toISOString());

  const labelMap = { [today]: "Aujourd'hui", [yesterday]: "Hier", [tomorrow]: "Demain" };

  Object.entries(groups).forEach(([date, items], i) => {
    const label = labelMap[date] || date;
    html += `<div class="section-label">${label}</div>`;
    items.forEach((p, j) => {
      html += renderCard(p, i * 10 + j);
    });
  });

  list.innerHTML = html;
}

function renderCard(p, idx) {
  const c = CARRIERS[p.carrier] || CARRIERS.other;
  const s = STATUS_LABELS[p.status];
  const exp = expandedCards.has(p.id);
  const sel = selectMode && selectedIds.has(p.id);
  const daysLeft = getDaysLeft(p.expiryDate);
  const urgency = p.status === 'ready' ? getUrgency(daysLeft) : 'none';
  const sourceLabel = getSourceLabel(p.source);
  const acct = appData.accounts[p.account];
  const acctName = acct ? acct.name : '';
  const clickHandler = selectMode
    ? `onclick="toggleSelectCard(${p.id}, event)"`
    : `onclick="toggleCard(${p.id})"`;

  return `
    <div class="pkg-card ${exp ? 'expanded' : ''} ${sel ? 'selected' : ''}" id="card-${p.id}" ${clickHandler} style="animation-delay:${idx * 40}ms">
      <div class="urgency-bar urgency-${urgency}"></div>
      <div class="pkg-card-header">
        ${selectMode ? `<div class="pkg-checkbox" onclick="toggleSelectCard(${p.id}, event)">${sel ? '‚úì' : ''}</div>` : ''}
        <div class="pkg-carrier-badge ${c.color}" style="padding:0;background:none;border:none;">
          ${carrierLogoHTML(p.carrier, 42)}
        </div>
        <div class="pkg-main">
          <div class="pkg-carrier-name">${c.name}</div>
          <div class="pkg-locker">üìç ${p.lockerAddress}</div>
          <div class="pkg-source-badge">${sourceLabel} ¬∑ ${acctName}</div>
        </div>
        <div class="pkg-right">
          <div class="pkg-status ${s.cls}">${s.label}</div>
          <div class="pkg-date">${formatDate(p.arrivalDate)}</div>
          ${p.expiryDate ? `<div class="days-left ${getDaysClass(daysLeft)}">${daysLeft !== null ? (daysLeft < 0 ? `exp. ${Math.abs(daysLeft)}j` : `${daysLeft}j restants`) : ''}</div>` : ''}
        </div>
      </div>
      ${exp ? renderCardDetails(p) : ''}
    </div>`;
}

function renderCardDetails(p) {
  const mapsUrl = p.lockerAddressRaw
    ? `https://www.google.com/maps/search/${encodeURIComponent(p.lockerAddressRaw)}`
    : `https://www.google.com/maps/search/${encodeURIComponent(p.lockerAddress)}`;

  const expiryStr = p.expiryDate
    ? new Date(p.expiryDate).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', year:'numeric'})
    : '‚Äî';
  const arrivalStr = new Date(p.arrivalDate).toLocaleDateString('fr-FR', {weekday:'long', day:'numeric', month:'long', hour:'2-digit', minute:'2-digit'});

  const daysLeft = getDaysLeft(p.expiryDate);
  const daysClass = getDaysClass(daysLeft);
  const daysText = daysLeft === null ? '' : daysLeft < 0
    ? `‚ö†Ô∏è Expir√© depuis ${Math.abs(daysLeft)} jour(s)`
    : daysLeft === 0 ? '‚ö†Ô∏è Dernier jour !'
    : `${daysLeft} jour(s) restants`;

  return `
    <div class="pkg-details" onclick="event.stopPropagation()">

      <!-- ‚îÄ‚îÄ Statut issu du mail ‚îÄ‚îÄ -->
      ${p.emailSubject ? `
        <div style="background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:10px;">
          <div class="code-label">Dernier statut (mail)</div>
          <div style="font-size:12px;color:var(--text2);line-height:1.5;margin-top:4px;font-style:italic;">"${p.emailSubject}"</div>
        </div>
      ` : ''}

      <!-- ‚îÄ‚îÄ Num√©ro de colis ‚îÄ‚îÄ -->
      ${p.trackingNum ? `
        <div class="code-block" style="margin-bottom:10px;">
          <div>
            <div class="code-label">N¬∞ de colis</div>
            <div style="font-family:'Space Mono',monospace;font-size:15px;font-weight:700;letter-spacing:2px;color:var(--text);">${p.trackingNum}</div>
          </div>
          <button class="btn-copy" onclick="copyCode('${p.trackingNum}', this)">üìã Copier</button>
        </div>
      ` : ''}

      <!-- ‚îÄ‚îÄ Code de retrait ‚îÄ‚îÄ -->
      ${p.pickupCode ? `
        <div class="code-block" style="margin-bottom:10px;">
          <div>
            <div class="code-label">Code de retrait</div>
            <div class="code-value">${p.pickupCode}</div>
          </div>
          <button class="btn-copy" onclick="copyCode('${p.pickupCode}', this)">üìã Copier</button>
        </div>
      ` : ''}

      <!-- ‚îÄ‚îÄ QR Code ‚îÄ‚îÄ -->
      ${p.qrData ? `
        <button class="btn-qr" id="btn-qr-${p.id}" onclick="toggleQR(${p.id}, this)">üì∑ Afficher QR Code</button>
        <div id="qr-${p.id}" style="display:none">
          <div class="qr-container">
            <div id="qr-canvas-${p.id}"></div>
            <div class="qr-label">${p.qrData}</div>
          </div>
        </div>
      ` : ''}

      <!-- ‚îÄ‚îÄ Dates ‚îÄ‚îÄ -->
      <div style="background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:10px;">
        <div class="pkg-info-row" style="margin-bottom:6px;">
          <span>üìÖ Arriv√©e</span>
          <span>${arrivalStr}</span>
        </div>
        ${p.expiryDate ? `
          <div class="pkg-info-row" style="margin-bottom:4px;">
            <span>‚è≥ Limite de retrait</span>
            <span>${expiryStr}</span>
          </div>
          ${daysText ? `<div style="font-size:11px;font-family:'Space Mono',monospace;text-align:right;" class="${daysClass}">${daysText}</div>` : ''}
        ` : ''}
      </div>

      <!-- ‚îÄ‚îÄ Adresse locker ‚îÄ‚îÄ -->
      <div style="background:var(--bg);border-radius:10px;padding:10px 12px;margin-bottom:10px;">
        <div class="code-label" style="margin-bottom:6px;">üìç Adresse du locker</div>
        <div style="font-size:13px;color:var(--text);line-height:1.5;margin-bottom:8px;">
          ${p.lockerAddress !== 'Adresse non d√©tect√©e'
            ? p.lockerAddress
            : '<span style="color:var(--text3);font-style:italic;">Non d√©tect√©e</span>'}
        </div>
        ${p.lockerAddress !== 'Adresse non d√©tect√©e' ? `
          <a href="${mapsUrl}" target="_blank" rel="noopener" class="btn-map" style="display:inline-flex;">
            üó∫Ô∏è Ouvrir dans Google Maps
          </a>
        ` : ''}
      </div>

      <!-- ‚îÄ‚îÄ Lien vers le mail ‚îÄ‚îÄ -->
      ${p.gmailLink ? `
        <a href="${p.gmailLink}" target="_blank" rel="noopener"
           style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:var(--bg);border-radius:10px;text-decoration:none;color:var(--text2);font-size:12px;margin-bottom:10px;">
          <span style="font-size:16px;">üìß</span>
          <span>Voir le mail original dans Gmail</span>
          <span style="margin-left:auto;color:var(--text3)">‚Ä∫</span>
        </a>
      ` : ''}

      <!-- ‚îÄ‚îÄ Marquer r√©cup√©r√© ‚îÄ‚îÄ -->
      ${p.status !== 'collected' ? `
        <div class="divider" style="margin:6px 0 10px"></div>
        <button class="btn-collected" onclick="markCollected(${p.id}, event)">‚úì Marquer comme r√©cup√©r√©</button>
      ` : ''}
    </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function formatDate(iso) {
  const d = new Date(iso);
  return d.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
}

function formatDateGroup(iso) {
  return new Date(iso).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' });
}

function getDaysLeft(expiryDate) {
  if (!expiryDate) return null;
  const exp = new Date(expiryDate);
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  exp.setHours(0, 0, 0, 0);
  return Math.round((exp - now) / 86400000);
}

function getUrgency(daysLeft) {
  if (daysLeft === null) return 'none';
  if (daysLeft < 0) return 'high';
  if (daysLeft <= 2) return 'high';
  if (daysLeft <= 5) return 'med';
  return 'low';
}

function getDaysClass(daysLeft) {
  if (daysLeft === null) return '';
  if (daysLeft < 0 || daysLeft <= 2) return 'days-urgent';
  if (daysLeft <= 5) return 'days-warn';
  return 'days-ok';
}

function getSourceLabel(source) {
  const map = {
    account1_gmail: 'üìß Gmail',
    account1_sms: 'üí¨ SMS',
    account2_gmail: 'üìß Gmail',
    account2_sms: 'üí¨ SMS',
    manual: '‚úèÔ∏è Manuel'
  };
  return map[source] || source;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SELECTION MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let selectMode = false;
let selectedIds = new Set();

function toggleSelectMode() {
  selectMode = !selectMode;
  selectedIds.clear();
  expandedCards.clear();
  const btn = document.getElementById('selectModeBtn');
  btn.classList.toggle('active', selectMode);
  btn.textContent = selectMode ? 'Terminer' : 'S√©lectionner';
  document.getElementById('bulkBar').classList.toggle('open', false);
  renderPackages();
}

function cancelSelectMode() {
  selectMode = false;
  selectedIds.clear();
  expandedCards.clear();
  const btn = document.getElementById('selectModeBtn');
  btn.classList.remove('active');
  btn.textContent = 'S√©lectionner';
  document.getElementById('bulkBar').classList.remove('open');
  renderPackages();
}

function toggleSelectCard(id, e) {
  e.stopPropagation();
  if (selectedIds.has(id)) {
    selectedIds.delete(id);
  } else {
    selectedIds.add(id);
  }
  const count = selectedIds.size;
  document.getElementById('bulkCount').textContent = count + ' s√©lectionn√©' + (count > 1 ? 's' : '');
  document.getElementById('bulkBar').classList.toggle('open', count > 0);
  // Update just the card DOM instead of full re-render for responsiveness
  const card = document.getElementById('card-' + id);
  if (card) {
    card.classList.toggle('selected', selectedIds.has(id));
    const cb = card.querySelector('.pkg-checkbox');
    if (cb) cb.textContent = selectedIds.has(id) ? '‚úì' : '';
  }
}

function bulkSetStatus(status) {
  if (selectedIds.size === 0) return;
  const label = STATUS_LABELS[status]?.label || status;
  if (!confirm('Changer ' + selectedIds.size + ' colis en "' + label + '" ?')) return;
  appData.packages.forEach(p => {
    if (selectedIds.has(p.id)) p.status = status;
  });
  saveData(appData);
  showToast('‚úì ' + selectedIds.size + ' colis mis √† jour : ' + label);
  cancelSelectMode();
  render();
}

function bulkDelete() {
  if (selectedIds.size === 0) return;
  if (!confirm('Supprimer d√©finitivement ' + selectedIds.size + ' colis ?')) return;
  appData.packages = appData.packages.filter(p => !selectedIds.has(p.id));
  saveData(appData);
  showToast('üóë ' + selectedIds.size + ' colis supprim√©s');
  cancelSelectMode();
  render();
}

function toggleCard(id) {
  if (selectMode) { toggleSelectCard(id, event); return; }
  if (expandedCards.has(id)) {
    expandedCards.delete(id);
  } else {
    expandedCards.clear();
    expandedCards.add(id);
  }
  renderPackages();
}

function toggleQR(id, btn) {
  const qrDiv = document.getElementById('qr-' + id);
  const canvasDiv = document.getElementById('qr-canvas-' + id);
  if (qrDiv.style.display === 'none') {
    qrDiv.style.display = 'block';
    btn.textContent = '‚úï Fermer QR Code';
    // Generate real QR only once
    if (canvasDiv && !canvasDiv._qrGenerated) {
      const pkg = appData.packages.find(p => p.id === id);
      if (pkg && pkg.qrData) {
        canvasDiv.innerHTML = '';
        try {
          new QRCode(canvasDiv, {
            text: pkg.qrData,
            width: 200,
            height: 200,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.M
          });
        } catch(e) {
          canvasDiv.innerHTML = '<p style="color:#333;font-size:12px;padding:10px">Erreur g√©n√©ration QR</p>';
        }
        canvasDiv._qrGenerated = true;
      }
    }
  } else {
    qrDiv.style.display = 'none';
    btn.textContent = 'üì∑ Afficher QR Code';
  }
}

function copyCode(code, btn) {
  navigator.clipboard.writeText(code).then(() => {
    btn.textContent = '‚úì Copi√©!';
    btn.classList.add('copied');
    showToast('Code copi√© : ' + code);
    setTimeout(() => { btn.textContent = 'üìã Copier'; btn.classList.remove('copied'); }, 2000);
  }).catch(() => {
    // fallback
    const el = document.createElement('textarea');
    el.value = code;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
    showToast('Code copi√© : ' + code);
  });
}

function markCollected(id, e) {
  e.stopPropagation();
  const pkg = appData.packages.find(p => p.id === id);
  if (pkg) {
    pkg.status = 'collected';
    expandedCards.delete(id);
    saveData(appData);
    render();
    showToast('‚úì Colis marqu√© comme r√©cup√©r√©');
  }
}

function showView(name, el) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  document.getElementById('view-' + name).classList.add('active');
  el.classList.add('active');
  if (name === 'locations') renderLocations();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCATION VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let openLocations = new Set();

function setLocSort(sort, el) {
  locSort = sort;
  document.querySelectorAll('.loc-sort-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderLocations();
}

function toggleLocationGroup(address) {
  if (openLocations.has(address)) {
    openLocations.delete(address);
  } else {
    openLocations.add(address);
  }
  renderLocations();
}

function renderLocations() {
  const el = document.getElementById('locationList');
  if (!el) return;

  // Group packages by address (exclude collected if desired ‚Äî keep all here)
  const groups = {};
  appData.packages.forEach(p => {
    const addr = p.lockerAddress;
    if (!groups[addr]) groups[addr] = [];
    groups[addr].push(p);
  });

  // Build group array with computed metrics
  let groupArr = Object.entries(groups).map(([addr, pkgs]) => {
    const active = pkgs.filter(p => p.status !== 'collected');
    const hasExpired = pkgs.some(p => p.status === 'expired');
    const hasReady   = pkgs.some(p => p.status === 'ready');
    // Urgency score: expired=0, ready with <2d=1, ready=2, pending=3, collected=4
    let urgScore = 99;
    pkgs.forEach(p => {
      if (p.status === 'expired') urgScore = Math.min(urgScore, 0);
      else if (p.status === 'ready') {
        const dl = getDaysLeft(p.expiryDate);
        if (dl !== null && dl <= 2) urgScore = Math.min(urgScore, 1);
        else urgScore = Math.min(urgScore, 2);
      } else if (p.status === 'pending') urgScore = Math.min(urgScore, 3);
      else urgScore = Math.min(urgScore, 4);
    });
    return { addr, pkgs, active, hasExpired, hasReady, urgScore };
  });

  // Sort
  if (locSort === 'count') {
    groupArr.sort((a, b) => b.pkgs.length - a.pkgs.length || a.addr.localeCompare(b.addr));
  } else if (locSort === 'urgency') {
    groupArr.sort((a, b) => a.urgScore - b.urgScore || b.pkgs.length - a.pkgs.length);
  } else {
    groupArr.sort((a, b) => a.addr.localeCompare(b.addr));
  }

  if (groupArr.length === 0) {
    el.innerHTML = `
      <div class="empty-state">
        <div class="empty-icon">üó∫Ô∏è</div>
        <div class="empty-title">Aucune adresse</div>
        <div class="empty-desc">Ajoutez des colis pour voir les adresses.</div>
      </div>`;
    return;
  }

  // Auto-open groups with urgent packages on first visit
  if (openLocations.size === 0) {
    groupArr.forEach(g => {
      if (g.hasExpired || g.hasReady) openLocations.add(g.addr);
    });
  }

  let html = `<div class="section-label">${groupArr.length} locker${groupArr.length > 1 ? 's' : ''} r√©f√©renc√©${groupArr.length > 1 ? 's' : ''}</div>`;

  groupArr.forEach(({ addr, pkgs, active, hasExpired, hasReady, urgScore }, i) => {
    const isOpen = openLocations.has(addr);
    const borderCls = hasExpired ? 'has-expired' : (hasReady ? 'has-ready' : '');

    // Status counts for strip
    const counts = { ready: 0, pending: 0, expired: 0, collected: 0 };
    pkgs.forEach(p => counts[p.status]++);
    let stripHtml = '';
    if (counts.ready)     stripHtml += `<span class="loc-strip-chip lsc-ready">‚úì ${counts.ready} pr√™t${counts.ready>1?'s':''}</span>`;
    if (counts.pending)   stripHtml += `<span class="loc-strip-chip lsc-pending">‚ü≥ ${counts.pending} en route</span>`;
    if (counts.expired)   stripHtml += `<span class="loc-strip-chip lsc-expired">‚ö† ${counts.expired} expir√©${counts.expired>1?'s':''}</span>`;
    if (counts.collected) stripHtml += `<span class="loc-strip-chip lsc-collected">‚úì ${counts.collected} r√©cup√©r√©${counts.collected>1?'s':''}</span>`;

    // Package items
    let itemsHtml = '';
    const sorted = [...pkgs].sort((a, b) => {
      const ord = { expired:0, ready:1, pending:2, collected:3 };
      return ord[a.status] - ord[b.status] || new Date(b.arrivalDate) - new Date(a.arrivalDate);
    });
    sorted.forEach(p => {
      const c = CARRIERS[p.carrier] || CARRIERS.other;
      const s = STATUS_LABELS[p.status];
      const dl = getDaysLeft(p.expiryDate);
      const dlText = dl !== null ? (dl < 0 ? `expir√© ${Math.abs(dl)}j` : `${dl}j restants`) : '';
      itemsHtml += `
        <div class="location-pkg-item" onclick="jumpToPackage(${p.id})">
          ${carrierLogoHTML(p.carrier, 32)}
          <div class="loc-pkg-info">
            <div class="loc-pkg-carrier">${c.name}</div>
            ${p.pickupCode ? `<div class="loc-pkg-code">${p.pickupCode}</div>` : ''}
            <div class="loc-pkg-date">${formatDate(p.arrivalDate)}${dlText ? ' ¬∑ ' + dlText : ''}</div>
          </div>
          <span class="loc-pkg-status ${s.cls}">${s.label}</span>
        </div>`;
    });

    // Codes summary for copy-all
    const codes = pkgs.filter(p => p.pickupCode && p.status !== 'collected').map(p => `${CARRIERS[p.carrier]?.name || p.carrier}: ${p.pickupCode}`).join('\n');
    const mapsUrl = `https://www.google.com/maps/search/${encodeURIComponent(addr)}`;

    html += `
      <div class="location-group ${borderCls} ${isOpen ? 'open' : ''}" style="animation-delay:${i*40}ms">
        <div class="location-group-header" onclick="toggleLocationGroup(${JSON.stringify(addr)})">
          <div class="location-pin">
            üìç
            ${pkgs.length > 1 ? `<div class="location-count-badge">${pkgs.length}</div>` : ''}
          </div>
          <div class="location-info">
            <div class="location-name">${addr}</div>
            <div class="loc-status-strip">${stripHtml}</div>
          </div>
          <span class="location-chevron">‚Ä∫</span>
        </div>
        <div class="location-pkg-list">
          ${itemsHtml}
        </div>
        <div class="location-actions">
          <a class="btn-map" href="${mapsUrl}" target="_blank" rel="noopener">üó∫Ô∏è Ouvrir dans Maps</a>
          ${codes ? `<button class="btn-copy-all" onclick="copyAllCodes(${JSON.stringify(codes)}, this)">üìã Codes</button>` : ''}
        </div>
      </div>`;
  });

  el.innerHTML = html;
}

function copyAllCodes(codes, btn) {
  navigator.clipboard.writeText(codes).catch(() => {
    const el = document.createElement('textarea');
    el.value = codes;
    document.body.appendChild(el);
    el.select();
    document.execCommand('copy');
    document.body.removeChild(el);
  });
  const orig = btn.textContent;
  btn.textContent = '‚úì Copi√©';
  showToast('‚úì Codes copi√©s');
  setTimeout(() => btn.textContent = orig, 1800);
}

function jumpToPackage(id) {
  // Switch to packages view, expand the card
  const navItems = document.querySelectorAll('.nav-item');
  showView('packages', navItems[0]);
  expandedCards.clear();
  expandedCards.add(id);
  renderPackages();
  // Scroll to the card
  setTimeout(() => {
    const card = document.getElementById('card-' + id);
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' });
  }, 100);
}

function setFilter(filter, el) {
  currentFilter = filter;
  document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
  el.classList.add('active');
  renderPackages();
}

function filterPackages(q) {
  currentSearch = q;
  renderPackages();
}

function openSearch() {
  const bar = document.getElementById('searchBar');
  bar.style.display = 'flex';
  document.getElementById('searchInput').focus();
}

function closeSearch() {
  document.getElementById('searchBar').style.display = 'none';
  currentSearch = '';
  document.getElementById('searchInput').value = '';
  renderPackages();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD PACKAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openAddModal() {
  document.getElementById('addModal').classList.add('open');
  // Default date to now
  const now = new Date();
  now.setMinutes(0, 0, 0);
  document.getElementById('arrivalDate').value = now.toISOString().slice(0, 16);
  const expiry = new Date(now.getTime() + 14 * 86400000);
  document.getElementById('expiryDate').value = expiry.toISOString().split('T')[0];
  selectedCarrier = null;
  document.querySelectorAll('.carrier-btn').forEach(b => b.classList.remove('selected'));
}

function closeModal() {
  document.getElementById('addModal').classList.remove('open');
}

function selectCarrier(name, el) {
  selectedCarrier = name;
  document.querySelectorAll('.carrier-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function addPackage() {
  if (!selectedCarrier) { showToast('‚ö†Ô∏è S√©lectionnez un transporteur'); return; }
  const address = document.getElementById('lockerAddress').value.trim();
  const code = document.getElementById('pickupCode').value.trim();
  if (!address) { showToast('‚ö†Ô∏è Adresse du locker requise'); return; }

  const pkg = {
    id: appData.nextId++,
    carrier: selectedCarrier,
    lockerAddress: address,
    pickupCode: code,
    trackingNum: document.getElementById('trackingNum').value.trim(),
    qrData: code ? `${selectedCarrier.toUpperCase()}-${code}` : null,
    arrivalDate: new Date(document.getElementById('arrivalDate').value).toISOString(),
    expiryDate: document.getElementById('expiryDate').value,
    status: 'ready',
    source: document.getElementById('sourceAccount').value,
    account: document.getElementById('sourceAccount').value.startsWith('account1') ? 1 : 2,
    note: ''
  };

  appData.packages.unshift(pkg);
  saveData(appData);
  closeModal();
  render();
  showToast('‚úì Colis ajout√© !');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OAUTH & GMAIL CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Gmail API scopes needed (read-only)
const GMAIL_SCOPE = 'https://www.googleapis.com/auth/gmail.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile';

// ‚îÄ‚îÄ‚îÄ Dur√©e de conservation par d√©faut (jours) par transporteur ‚îÄ‚îÄ‚îÄ
const CARRIER_RETENTION = {
  chronopost: 8, mondialrelay: 14, colissimo: 15,
  laposte: 15, vintedgo: 14, amazon: 3, dpd: 14, ups: 10, other: 14
};

// ‚îÄ‚îÄ‚îÄ Mots-cl√©s de statut (ordre priorit√© : expired > ready > pending) ‚îÄ‚îÄ‚îÄ
const STATUS_KEYWORDS = {
  expired: ['retourn√©', 'non r√©cup√©r√©', 'renvoy√©', 'd√©lai d√©pass√©', 'retour exp√©diteur'],
  ready:   ['disponible', '√† retirer', '√† r√©cup√©rer', 'est arriv√©', 'remis en point',
            'livr√© en point', 'pickup ready', 'vous pouvez retirer', 'en attente de retrait',
            'd√©pos√© dans', 'consigne disponible', 'est disponible'],
  pending: ['en chemin', 'en cours', 'en transit', 'exp√©di√©', 'pris en charge', 'en route',
            'en livraison', 'out for delivery', 'shipped', 'in transit', 'achemin√©',
            'sera livr√©', 'est en route', 'confi√© par', 'sera disponible', 'en pr√©paration']
};

// ‚îÄ‚îÄ‚îÄ D√©tection transporteur (du plus sp√©cifique au plus g√©n√©ral) ‚îÄ‚îÄ‚îÄ
const CARRIER_DETECTORS = [
  // Colissimo : from @laposte.fr, body "Colissimo"
  // Ex sujet: "Votre Colissimo confi√© par La boutique des saucissons sera livr√© lundi 02 f√©vrier"
  // Tracking: 6M22242695271 (alphanum 13 cars)
  { carrier: 'colissimo',
    test: (f,s,b) => /colissimo/i.test(b) || /colissimo/i.test(s) || /laposte\.(fr|net|com)/i.test(f) },

  // Chronopost : from @chronopost.fr
  // Ex sujet: "Votre colis PP918217783FR exp√©di√© par AMAZON est en chemin"
  // Tracking: PP918217783FR (2L + 9N + 2L)
  { carrier: 'chronopost',
    test: (f,s,b) => /chronopost/i.test(f) || /chronopost/i.test(s) || /chronopost/i.test(b) },

  // Mondial Relay : from @mondialrelay.fr
  // Ex corps: "Votre colis 05881576 ... Point Relais¬Æ ... Coccinelle Express\n8 Espl..."
  // Tracking: 05881576 (8 chiffres)
  { carrier: 'mondialrelay',
    test: (f,s,b) => /mondial.?relay/i.test(f) || /mondial.?relay/i.test(s) || /point relais/i.test(b) },

  // Vinted Go : from @vinted.fr
  { carrier: 'vintedgo',
    test: (f,s,b) => /vinted/i.test(f) || /vinted/i.test(s) },

  // Amazon : from @amazon.fr
  { carrier: 'amazon',
    test: (f,s,b) => /amazon/i.test(f) || /amazon locker|amazon hub/i.test(b) },

  // DPD : from @dpd.fr
  { carrier: 'dpd',
    test: (f,s,b) => /\bdpd\b/i.test(f) || /\bdpd\b/i.test(s) },

  // UPS
  { carrier: 'ups',
    test: (f,s,b) => /\bups\b/i.test(f) || /\bups\b/i.test(s) },

  // La Poste g√©n√©rique
  { carrier: 'laposte',
    test: (f,s,b) => /laposte/i.test(f) || /la poste/i.test(s) },
];

// ‚îÄ‚îÄ‚îÄ Extraction n¬∞ de suivi par transporteur ‚îÄ‚îÄ‚îÄ
function extractTrackingNumber(carrier, text) {
  const byCarrier = {
    // "n¬∞6M22242695271" ou "colis n¬∞6M..."
    colissimo:    [/n[¬∞o]\s*([A-Z0-9]{9,15})\b/i, /colis\s+n[¬∞o]?\s*([A-Z0-9]{9,15})/i, /\b(6[A-Z]\d{11})\b/],
    // "PP918217783FR" ‚Äî 2L+9N+2L
    chronopost:   [/\bcolis\s+([A-Z]{2}\d{9}[A-Z]{2})\b/i, /\b([A-Z]{2}\d{9}[A-Z]{2})\b/],
    // "votre colis 05881576"
    mondialrelay: [/votre\s+colis\s+(\d{6,10})\b/i, /\bcolis\s+(\d{6,10})\b/i, /\b(\d{8})\b/],
    vintedgo:     [/\b([A-Z]{2}\d{9}[A-Z]{2})\b/, /\b(VG[A-Z0-9]{6,12})\b/i],
    amazon:       [/\b(\d{3}-\d{7}-\d{7})\b/, /order[^:\n]*:\s*([0-9A-Z\-]{10,20})/i],
    dpd:          [/\b(\d{14})\b/, /n[¬∞o][^:\n]{0,10}:\s*([0-9]{10,14})/i],
    ups:          [/\b(1Z[A-Z0-9]{16})\b/i],
    laposte:      [/n[¬∞o]\s*([A-Z0-9]{9,15})\b/i, /\b([A-Z]{2}\d{9}[A-Z]{2})\b/],
  };
  for (const re of (byCarrier[carrier] || [])) {
    const m = text.match(re);
    if (m?.[1] && m[1].length >= 6) return m[1].toUpperCase();
  }
  return '';
}

// ‚îÄ‚îÄ‚îÄ Extraction code de retrait ‚îÄ‚îÄ‚îÄ
function extractPickupCode(text) {
  const regexes = [
    /(?:code\s*(?:d[e']\s*)?(?:retrait|ouverture|acc√®s|locker|pickup))\s*[:\s]+([A-Z0-9]{4,10})/i,
    /(?:votre\s+code)\s*[:\s]+([A-Z0-9]{4,10})/i,
    /\bcode\b\s*:\s*([0-9]{4,8})\b/i,
    /\bpin\b\s*[:\s]+([0-9]{4,8})\b/i,
  ];
  for (const re of regexes) {
    const m = text.match(re);
    if (m?.[1]) return m[1];
  }
  return '';
}

// ‚îÄ‚îÄ‚îÄ Extraction adresse d√©p√¥t ‚îÄ‚îÄ‚îÄ
// Colissimo  : apr√®s "Votre point de retrait :\n\nNOM\nRUE\nCP VILLE"
// Mondial Relay : apr√®s "Votre Point Relais¬Æ de d√©p√¥t\nNOM\nRUE\nCP VILLE"
// Chronopost : "relais Pickup" ‚Äî adresse absente du 1er mail
function extractAddress(carrier, text) {
  const strategies = [
    // Colissimo ‚Äî "Votre point de retrait :\n\nNOM\n RUE\nCP VILLE"
    /(?:votre\s+point\s+de\s+retrait\s*:?\s*\n+)([\s\S]{5,200}?)(?:\n\n|facilitez|renseignez|besoin)/i,
    // Mondial Relay ‚Äî "Votre Point Relais¬Æ de d√©p√¥t\nNOM\nRUE\nCP VILLE\n\nCe message"
    /(?:votre\s+point\s+relais¬Æ?\s+de\s+(?:d√©p√¥t|livraison|retrait)\s*\n)([\s\S]{5,150}?)(?:\n\n|ce message|merci)/i,
    // Mondial Relay variante ‚Äî "Point Relais¬Æ :\nNOM\nRUE\nCP VILLE"
    /(?:point\s+relais¬Æ?\s*[:\n]\s*)([\s\S]{5,150}?)(?:\n\n|ce message|merci)/i,
    // G√©n√©rique ‚Äî apr√®s "adresse :", "locker :", "consigne :"
    /(?:adresse|locker|consigne)\s*[:\n]\s*([^\n]{5,80}(?:\n[^\n]{3,80}){0,3})/i,
  ];
  const JUNK = /^(ce message|merci|suivre|t√©l√©chargez|retrouvez|pour en|bonjour|facilitez|renseignez|donn√©es|mentions|www\.|un sourire|aidez)/i;
  for (const re of strategies) {
    const m = text.match(re);
    if (m?.[1]) {
      const lines = m[1].split('\n')
        .map(l => l.trim())
        .filter(l => l.length > 2 && !JUNK.test(l));
      if (lines.length > 0) {
        return lines.slice(0, 4).join(', ').replace(/,\s*,/g, ',').trim();
      }
    }
  }
  return '';
}

// ‚îÄ‚îÄ‚îÄ Extraction date limite ‚îÄ‚îÄ‚îÄ
function extractExpiryDate(text, arrivalDate, carrier) {
  // "disposez de 8 jours" ‚Äî Chronopost
  const durMatch = text.match(/(?:disposez?\s+de|pendant)\s+(\d+)\s+jours?/i);
  if (durMatch) {
    const d = new Date(arrivalDate);
    d.setDate(d.getDate() + parseInt(durMatch[1]));
    return d.toISOString().split('T')[0];
  }
  // "jusqu'au 15/02/2025" ou "avant le 15 f√©vrier"
  const dateMatch = text.match(/(?:jusqu['']au|avant le|retirer avant)[^\d]*(\d{1,2})[\/\-\s](\d{1,2})[\/\-\s](\d{2,4})/i);
  if (dateMatch) {
    const [, d, mo, y] = dateMatch;
    const year = y.length === 2 ? '20' + y : y;
    return `${year}-${mo.padStart(2,'0')}-${d.padStart(2,'0')}`;
  }
  // Fallback : dur√©e standard
  const days = CARRIER_RETENTION[carrier] || 14;
  const def = new Date(arrivalDate);
  def.setDate(def.getDate() + days);
  return def.toISOString().split('T')[0];
}

// ‚îÄ‚îÄ‚îÄ D√©tection statut depuis sujet + corps ‚îÄ‚îÄ‚îÄ
function detectStatus(text) {
  const lower = text.toLowerCase();
  for (const [status, keywords] of Object.entries(STATUS_KEYWORDS)) {
    if (keywords.some(kw => lower.includes(kw))) return status;
  }
  return 'pending';
}

// ‚îÄ‚îÄ‚îÄ Parsing principal d'un message Gmail ‚Üí objet colis ‚îÄ‚îÄ‚îÄ
function parseEmailToPackage(msg, accountSlot) {
  const headers = msg.payload?.headers || [];
  const from    = getHeader(headers, 'from');
  const subject = getHeader(headers, 'subject');
  const dateStr = getHeader(headers, 'date');
  const body    = getEmailBody(msg.payload);
  const fullText = subject + '\n' + body;
  const fromLow = from.toLowerCase();
  const subjLow = subject.toLowerCase();
  const bodyLow = body.toLowerCase();

  // 1. D√©tecter le transporteur
  const detector = CARRIER_DETECTORS.find(d => d.test(fromLow, subjLow, bodyLow));
  if (!detector) return null;
  const carrier = detector.carrier;

  // 2. Extraire les champs
  const trackingNum   = extractTrackingNumber(carrier, fullText);
  const pickupCode    = extractPickupCode(fullText);
  const lockerAddress = extractAddress(carrier, fullText);
  const arrivalDate   = new Date(dateStr || Date.now()).toISOString();
  const status        = detectStatus(fullText);
  const expiryDate    = extractExpiryDate(fullText, arrivalDate, carrier);

  // 3. Filtrer : garder seulement si on a un n¬∞ de suivi ou une adresse
  if (!trackingNum && !lockerAddress) return null;

  // 4. Lien direct vers le mail Gmail
  const gmailLink = `https://mail.google.com/mail/u/0/#inbox/${msg.id}`;

  return {
    id: null,
    carrier,
    lockerAddress: lockerAddress || 'Adresse non d√©tect√©e',
    lockerAddressRaw: lockerAddress,
    pickupCode,
    trackingNum,
    qrData: pickupCode ? `${carrier.toUpperCase()}-${pickupCode}` : (trackingNum || null),
    arrivalDate,
    expiryDate,
    status,
    emailSubject: subject.substring(0, 100),
    gmailLink,
    source: `account${accountSlot}_gmail`,
    account: accountSlot,
    gmailMsgId: msg.id,
    note: ''
  };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OAUTH & GMAIL ‚Äî CLIENT ID + TOKEN STORE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getClientId() {
  return localStorage.getItem('lockertrack_client_id') || '';
}

function saveClientId() {
  const val = document.getElementById('clientIdInput').value.trim();
  if (!val) { showToast('‚ö†Ô∏è Client ID vide'); return; }
  localStorage.setItem('lockertrack_client_id', val);
  updateClientIdStatus();
  toggleClientIdEdit();
  showToast('‚úì Client ID enregistr√©');
}

function toggleClientIdEdit() {
  const ed = document.getElementById('clientIdEdit');
  const isOpen = ed.style.display !== 'none';
  ed.style.display = isOpen ? 'none' : 'block';
  if (!isOpen) {
    document.getElementById('clientIdInput').value = getClientId();
  }
}

function updateClientIdStatus() {
  const cid = getClientId();
  const el = document.getElementById('clientIdStatus');
  if (el) {
    el.textContent = cid ? '‚úì Configur√© : ' + cid.substring(0, 24) + '‚Ä¶' : 'Non configur√©';
    el.style.color = cid ? 'var(--accent)' : 'var(--text3)';
  }
}

// ‚îÄ‚îÄ‚îÄ Token store par compte (slot 1 ou 2) ‚îÄ‚îÄ‚îÄ
function getTokenStore(n) {
  try { return JSON.parse(localStorage.getItem('lockertrack_token_' + n)) || null; }
  catch { return null; }
}
function setTokenStore(n, data) {
  localStorage.setItem('lockertrack_token_' + n, JSON.stringify(data));
}
function clearTokenStore(n) {
  localStorage.removeItem('lockertrack_token_' + n);
}

// ‚îÄ‚îÄ‚îÄ Connexion Gmail via Google Identity Services ‚îÄ‚îÄ‚îÄ
function connectGmail(n) {
  const clientId = getClientId();
  if (!clientId) {
    showToast("‚ö†Ô∏è Configurez d'abord votre Client ID");
    toggleClientIdEdit();
    return;
  }
  if (typeof google === 'undefined' || !google.accounts) {
    showToast('‚ö†Ô∏è Google Identity Services non charg√©');
    return;
  }
  showToast('üîê Connexion Google en cours‚Ä¶');
  const client = google.accounts.oauth2.initTokenClient({
    client_id: clientId,
    scope: GMAIL_SCOPE,
    callback: (resp) => {
      if (resp.error) { showToast('‚ùå Erreur OAuth : ' + resp.error); return; }
      fetchGoogleUserInfo(resp.access_token).then(info => {
        setTokenStore(n, {
          accessToken: resp.access_token,
          email: info.email,
          name: info.name,
          picture: info.picture,
          expiry: Date.now() + (resp.expires_in || 3600) * 1000
        });
        appData.accounts[n].email = info.email;
        appData.accounts[n].name = info.name || (n === 1 ? 'Compte principal' : 'Compte secondaire');
        saveData(appData);
        renderAccounts();
        showToast('‚úì ' + info.email + ' connect√©');
        setTimeout(() => syncAccount(n), 500);
      });
    }
  });
  client.requestAccessToken({ prompt: 'select_account' });
}

async function fetchGoogleUserInfo(accessToken) {
  const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  return r.json();
}

function disconnectAccount(n) {
  if (!confirm('D√©connecter ce compte Gmail ?')) return;
  const ts = getTokenStore(n);
  if (ts?.accessToken && typeof google !== 'undefined') {
    google.accounts.oauth2.revoke(ts.accessToken, () => {});
  }
  clearTokenStore(n);
  appData.accounts[n].email = '';
  appData.accounts[n].name = n === 1 ? 'Compte principal' : 'Compte secondaire';
  appData.accounts[n].lastSync = null;
  saveData(appData);
  renderAccounts();
  showToast('‚úì Compte d√©connect√©');
}

// ‚îÄ‚îÄ‚îÄ Gmail API fetch ‚îÄ‚îÄ‚îÄ
async function gmailFetch(accessToken, path) {
  const r = await fetch('https://gmail.googleapis.com/gmail/v1/' + path, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  if (!r.ok) throw new Error('Gmail API ' + r.status);
  return r.json();
}

function decodeBase64(str) {
  try { return decodeURIComponent(escape(atob(str.replace(/-/g, '+').replace(/_/g, '/')))); }
  catch { return ''; }
}

function getEmailBody(payload) {
  if (!payload) return '';
  if (payload.body?.data) return decodeBase64(payload.body.data);
  if (payload.parts) {
    for (const part of payload.parts) {
      if (part.mimeType === 'text/plain' && part.body?.data) return decodeBase64(part.body.data);
    }
    for (const part of payload.parts) {
      const sub = getEmailBody(part);
      if (sub) return sub;
    }
  }
  return '';
}

function getHeader(headers, name) {
  return headers?.find(h => h.name.toLowerCase() === name.toLowerCase())?.value || '';
}


// ‚îÄ‚îÄ‚îÄ Sync one account ‚îÄ‚îÄ‚îÄ
async function syncAccount(n) {
  const ts = getTokenStore(n);
  if (!ts?.accessToken) {
    showToast(`‚ö†Ô∏è Compte ${n} non connect√©`);
    return;
  }

  // Check token expiry
  if (Date.now() > ts.expiry - 60000) {
    showToast(`‚ö†Ô∏è Session expir√©e ‚Äî reconnectez le compte ${n}`);
    clearTokenStore(n);
    renderAccounts();
    return;
  }

  const btn = document.getElementById('syncBtn' + n);
  const span = btn?.querySelector('span');
  if (span) span.style.animation = 'spin 1s linear infinite';
  if (btn) btn.disabled = true;
  animateProgress('progress' + n, 3000);

  const resultEl = document.getElementById(`acc${n}syncResult`);
  if (resultEl) { resultEl.style.display = 'block'; resultEl.textContent = 'üîç Recherche des mails transporteurs‚Ä¶'; }

  try {
    // Build Gmail search query ‚Äî locker/colis keywords from all carriers
    const query = 'subject:(locker OR "point relais" OR "√† retirer" OR "disponible" OR "pickup" OR "colis disponible" OR "votre colis") newer_than:30d';
    const listResp = await gmailFetch(ts.accessToken, `users/me/messages?maxResults=50&q=${encodeURIComponent(query)}`);
    const messages = listResp.messages || [];

    if (resultEl) resultEl.textContent = `üì¨ ${messages.length} email(s) trouv√©(s) ‚Äî analyse en cours‚Ä¶`;

    let newCount = 0;
    let skipCount = 0;
    const existingMsgIds = new Set(appData.packages.map(p => p.gmailMsgId).filter(Boolean));

    for (const m of messages) {
      if (existingMsgIds.has(m.id)) { skipCount++; continue; }

      const full = await gmailFetch(ts.accessToken, `users/me/messages/${m.id}?format=full`);
      const pkg = parseEmailToPackage(full, n);
      if (pkg) {
        pkg.id = appData.nextId++;
        appData.packages.unshift(pkg);
        newCount++;
      }
    }

    appData.accounts[n].lastSync = new Date().toISOString();
    saveData(appData);
    render();

    const msg = newCount > 0
      ? `‚úì ${newCount} nouveau(x) colis d√©tect√©(s) ! (${skipCount} d√©j√† connus)`
      : `‚úì Aucun nouveau colis (${messages.length} mails analys√©s)`;
    if (resultEl) resultEl.textContent = msg;
    showToast(msg);

  } catch (err) {
    const errMsg = '‚ùå Erreur : ' + (err.message || 'connexion impossible');
    if (resultEl) resultEl.textContent = errMsg;
    showToast(errMsg);
  } finally {
    if (span) span.style.animation = '';
    if (btn) btn.disabled = false;
    renderAccounts();
  }
}

async function syncAll() {
  const btn = document.getElementById('syncBtn');
  btn.style.animation = 'spin 1s linear infinite';
  showToast('üîÑ Synchronisation en cours‚Ä¶');

  const connected = [1, 2].filter(n => getTokenStore(n)?.accessToken);
  if (connected.length === 0) {
    btn.style.animation = '';
    showToast('‚ö†Ô∏è Aucun compte connect√©');
    return;
  }

  for (const n of connected) {
    await syncAccount(n);
  }

  btn.style.animation = '';
  btn.textContent = '‚ü≥';
}

// ‚îÄ‚îÄ‚îÄ Render accounts UI ‚îÄ‚îÄ‚îÄ
function renderAccounts() {
  [1, 2].forEach(n => {
    const ts = getTokenStore(n);
    const acc = appData.accounts[n];
    const connected = !!(ts?.accessToken && Date.now() < ts.expiry);

    // Name & email
    document.getElementById('acc' + n + 'name').textContent = connected ? (ts.name || acc.name) : (n === 1 ? 'Compte principal' : 'Compte secondaire');
    document.getElementById('acc' + n + 'email').textContent = connected ? ts.email : 'Non connect√©';

    // Avatar ‚Äî use Google profile picture if available
    const avatar = document.getElementById('acc' + n + 'avatar');
    if (connected && ts.picture) {
      avatar.innerHTML = `<img src="${ts.picture}" style="width:100%;height:100%;border-radius:12px;object-fit:cover;" onerror="this.parentElement.textContent='üë§'">`;
    } else {
      avatar.textContent = 'üë§';
    }

    // Buttons visibility
    document.getElementById('acc' + n + 'connectBtn').style.display = connected ? 'none' : 'block';
    document.getElementById('acc' + n + 'disconnectBtn').style.display = connected ? 'block' : 'none';
    document.getElementById('syncBtn' + n).style.display = connected ? 'flex' : 'none';

    // Source tags
    const sourcesEl = document.getElementById('acc' + n + 'sources');
    if (connected) {
      sourcesEl.innerHTML = `
        <span class="source-tag gmail">üìß Gmail connect√©</span>
        <span class="source-tag status-ok">‚óè Actif</span>`;
    } else {
      sourcesEl.innerHTML = `<span class="source-tag" style="background:rgba(0,0,0,0.05);color:var(--text3)">üìß Gmail non connect√©</span>`;
    }

    // Last sync
    const ls = appData.accounts[n].lastSync;
    const lsEl = document.getElementById('lastSync' + n);
    if (ls) {
      const d = new Date(ls);
      const dateStr = d.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
      const timeStr = d.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      lsEl.innerHTML = 'üîÑ Derni√®re sync<br><span style="font-family:"Space Mono",monospace;font-size:11px;color:var(--text);">' + dateStr + ' √† ' + timeStr + '</span>';
    } else {
      lsEl.textContent = 'Jamais synchronis√©';
    }

    // Token expiry warning
    if (connected && Date.now() > ts.expiry - 300000) {
      lsEl.innerHTML += ' <span style="color:var(--accent3)">¬∑ ‚ö†Ô∏è Session expire bient√¥t</span>';
    }
  });

  // Setup banner
  const anyConnected = [1,2].some(n => getTokenStore(n)?.accessToken);
  const banner = document.getElementById('setupBanner');
  if (banner) banner.style.display = anyConnected ? 'none' : 'block';

  updateClientIdStatus();
}

function requestSMSAccess() {
  showToast('‚ö†Ô∏è Requiert l\'app Android native');
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function saveSetting(key, value) {
  appData.settings[key] = value;
  saveData(appData);
  showToast('‚úì Param√®tre enregistr√©');
}

function exportData() {
  const json = JSON.stringify(appData, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'lockertrack-export.json';
  a.click();
  showToast('‚úì Export t√©l√©charg√©');
}

function clearCollected() {
  const n = appData.packages.filter(p => p.status === 'collected').length;
  if (n === 0) { showToast('Aucun colis r√©cup√©r√© √† supprimer'); return; }
  appData.packages = appData.packages.filter(p => p.status !== 'collected');
  saveData(appData);
  render();
  showToast(`‚úì ${n} colis supprim√©(s)`);
}

function confirmReset() {
  if (confirm('Supprimer TOUTES les donn√©es ? Cette action est irr√©versible.')) {
    localStorage.removeItem(STORAGE_KEY);
    appData = {
      packages: [],
      accounts: {
        1: { name: 'Compte principal', email: '', phone: '', lastSync: null },
        2: { name: 'Compte secondaire', email: '', phone: '', lastSync: null }
      },
      settings: { notifExpiry: true, notifReady: true, syncFreq: '30' },
      nextId: 1
    };
    saveData(appData);
    render();
    showToast('‚úì Donn√©es r√©initialis√©es');
  }
}

function animateProgress(id, duration) {
  const bar = document.getElementById(id);
  if (!bar) return;
  bar.style.width = '0%';
  bar.style.transition = 'width ' + duration + 'ms ease';
  requestAnimationFrame(() => { bar.style.width = '100%'; });
  setTimeout(() => { bar.style.width = '0%'; bar.style.transition = 'none'; }, duration + 200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let toastTimer = null;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

document.getElementById('addModal').addEventListener('click', e => {
  if (e.target === document.getElementById('addModal')) closeModal();
});

// Init settings UI
document.getElementById('notifExpiry').checked = appData.settings.notifExpiry;
document.getElementById('notifReady').checked = appData.settings.notifReady;
document.getElementById('syncFreq').value = appData.settings.syncFreq;

// Init OAuth UI
updateClientIdStatus();

// Show home button only when running as installed PWA
(function() {
  const isStandalone = window.matchMedia('(display-mode: standalone)').matches
    || window.navigator.standalone === true;
  if (isStandalone) {
    const btn = document.getElementById('homeBtn');
    if (btn) btn.style.display = 'flex';
  }
})();

// Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./sw.js')
      .then(reg => console.log('SW enregistr√©, scope:', reg.scope))
      .catch(err => console.warn('SW √©chec:', err));
  });
}

// Initial render
render();
</script>
</body>
</html>
